
前端重构计划 (React 前端最佳实践)                                                                                                                     
                                                                                                                                                        
  概述                                                                                                                                                  
                                                                                                                                                        
  该计划概述了对 MemStack React 前端的全面重构，以符合 React 19.2+ 最佳实践、Vercel 的 React 组合模式和现代性能优化技术。                               
                                                                                                                                                        
  当前技术栈: React 19.2+, TypeScript 5.9+, Vite 7.3+, Ant Design 6.1+, Zustand 5.0+                                                                    
                                                                                                                                                        
  ---                                                                                                                                                   
  当前状态分析                                                                                                                                          
                                                                                                                                                        
  优势                                                                                                                                                  
                                                                                                                                                        
  1. 代码分割：App.tsx 实现了路由懒加载                                                                                                                 
  2. 类型安全：完整的 TypeScript 类型定义                                                                                                               
  3. 状态管理：Zustand 使用 selector 模式进行细粒度订阅                                                                                                 
  4. 测试：60+ 测试文件使用 Vitest 和 Playwright                                                                                                        
                                                                                                                                                        
  识别的问题                                                                                                                                            
  ┌───────────────────────────────┬──────────────────────────────────────────┬──────────┐                                                               
  │           问题类别            │                   位置                   │ 严重程度 │                                                               
  ├───────────────────────────────┼──────────────────────────────────────────┼──────────┤                                                               
  │ 重复的 agent 组件             │ components/agent/ vs components/agentV3/ │ 高       │                                                               
  ├───────────────────────────────┼──────────────────────────────────────────┼──────────┤                                                               
  │ 单体 store (2000+ 行)         │ stores/agent.ts                          │ 严重     │                                                               
  ├───────────────────────────────┼──────────────────────────────────────────┼──────────┤                                                               
  │ 全局模块锁变量                │ stores/agent.ts ~616 行 sendMessageLock  │ 高       │                                                               
  ├───────────────────────────────┼──────────────────────────────────────────┼──────────┤                                                               
  │ Store 中直接访问 localStorage │ stores/auth.ts                           │ 中       │                                                               
  ├───────────────────────────────┼──────────────────────────────────────────┼──────────┤                                                               
  │ 缺少 React.memo               │ 大多数组件                               │ 高       │                                                               
  ├───────────────────────────────┼──────────────────────────────────────────┼──────────┤                                                               
  │ 缺少全局 Error Boundary       │ App.tsx                                  │ 严重     │                                                               
  ├───────────────────────────────┼──────────────────────────────────────────┼──────────┤                                                               
  │ any 类型使用                  │ stores/auth.ts                           │ 中       │                                                               
  ├───────────────────────────────┼──────────────────────────────────────────┼──────────┤                                                               
  │ 缺少虚拟滚动                  │ 消息列表、实体列表                       │ 中       │                                                               
  └───────────────────────────────┴──────────────────────────────────────────┴──────────┘                                                               
  ---                                                                                                                                                   
  实施计划                                                                                                                                              
                                                                                                                                                        
  第 1 阶段：基础与基础设施 (第 1 周)                                                                                                                   
                                                                                                                                                        
  1.1 添加全局 Error Boundary                                                                                                                           
  - 增强 components/common/ErrorBoundary.tsx                                                                                                            
  - 添加错误跟踪集成占位符、回退 UI、错误恢复机制                                                                                                       
                                                                                                                                                        
  1.2 添加 Barrel 导出                                                                                                                                  
  - 创建 components/agent/index.ts                                                                                                                      
  - 创建 components/common/index.ts                                                                                                                     
  - 创建根 components/index.ts                                                                                                                          
                                                                                                                                                        
  1.3 合并重复的 Agent 组件                                                                                                                             
  - 审计 agent/ 和 agentV3/ 的差异                                                                                                                      
  - 合并功能到单一组件集                                                                                                                                
  - 移除 agentV3/ 目录                                                                                                                                  
                                                                                                                                                        
  1.4 增强 TypeScript 严格模式                                                                                                                          
  - 添加 noUncheckedIndexedAccess                                                                                                                       
  - 添加 exactOptionalPropertyTypes                                                                                                                     
                                                                                                                                                        
  ---                                                                                                                                                   
  第 2 阶段：状态管理重构 (第 2 周)                                                                                                                     
                                                                                                                                                        
  2.1 拆分单体 Agent Store                                                                                                                              
  stores/agent/                                                                                                                                         
  ├── index.ts              # 主导出                                                                                                                    
  ├── conversationStore.ts  # 会话状态                                                                                                                  
  ├── messageStore.ts       # 消息、分页                                                                                                                
  ├── streamingStore.ts     # 流式传输                                                                                                                  
  ├── executionStore.ts     # WorkPlan、执行                                                                                                            
  ├── planModeStore.ts      # 计划模式                                                                                                                  
  └── selectors.ts          # 组合选择器                                                                                                                
                                                                                                                                                        
  2.2 添加 Zustand 持久化中间件                                                                                                                         
  - 替换直接的 localStorage 访问                                                                                                                        
                                                                                                                                                        
  2.3 修复全局模块锁                                                                                                                                    
  - 使用 Map 替代全局 sendMessageLock                                                                                                                   
  - 每个会话独立锁                                                                                                                                      
                                                                                                                                                        
  2.4 添加 Zustand DevTools                                                                                                                             
                                                                                                                                                        
  ---                                                                                                                                                   
  第 3 阶段：性能优化 (第 3 周)                                                                                                                         
                                                                                                                                                        
  3.1 添加 React.memo                                                                                                                                   
  - MessageBubble、WorkPlanCard、ToolExecutionCard 等                                                                                                   
                                                                                                                                                        
  3.2 使用 useCallback 优化回调                                                                                                                         
  - 传递给子组件的事件处理程序                                                                                                                          
  - useEffect 依赖中的函数                                                                                                                              
                                                                                                                                                        
  3.3 添加 useMemo                                                                                                                                      
  - 过滤/转换数组                                                                                                                                       
  - 复杂对象构建                                                                                                                                        
                                                                                                                                                        
  3.4 实现虚拟滚动                                                                                                                                      
  - 使用 @tanstack/react-virtual                                                                                                                        
  - 应用于消息列表、实体列表                                                                                                                            
                                                                                                                                                        
  3.5 优化文本增量缓冲                                                                                                                                  
  - requestAnimationFrame 批处理                                                                                                                        
                                                                                                                                                        
  ---                                                                                                                                                   
  第 4 阶段：API 服务层重构 (第 4 周)                                                                                                                   
                                                                                                                                                        
  4.1 合并 Axios 实例                                                                                                                                   
  - 创建单一 axios 实例配置                                                                                                                             
  services/                                                                                                                                             
  ├── client/                                                                                                                                           
  │   ├── axios.ts           # 单一实例                                                                                                                 
  │   ├── interceptors.ts    # 请求/响应处理                                                                                                            
  │   └── config.ts                                                                                                                                     
  ├── api/                                                                                                                                              
  │   ├── auth.ts                                                                                                                                       
  │   ├── agent.ts                                                                                                                                      
  │   └── ...                                                                                                                                           
                                                                                                                                                        
  4.2 添加请求缓存层                                                                                                                                    
  - GET 请求缓存                                                                                                                                        
                                                                                                                                                        
  4.3 添加请求去重                                                                                                                                      
  - 跟踪进行中的请求                                                                                                                                    
                                                                                                                                                        
  ---                                                                                                                                                   
  第 5 阶段：TypeScript 类型安全 (第 5 周)                                                                                                              
                                                                                                                                                        
  5.1 移除 any 类型                                                                                                                                     
  - 替换为正确的类型或带类型保护的 unknown                                                                                                              
                                                                                                                                                        
  5.2 创建共享类型导出                                                                                                                                  
  - types/index.ts barrel export                                                                                                                        
                                                                                                                                                        
  ---                                                                                                                                                   
  第 6 阶段：组件重构 (第 6 周)                                                                                                                         
                                                                                                                                                        
  6.1 应用组合模式                                                                                                                                      
  - 复杂 UI 使用复合组件                                                                                                                                
  - 提取 render props                                                                                                                                   
                                                                                                                                                        
  6.2 提取自定义 Hooks                                                                                                                                  
  hooks/                                                                                                                                                
  ├── useAgentChat.ts                                                                                                                                   
  ├── useWebSocket.ts                                                                                                                                   
  ├── usePagination.ts                                                                                                                                  
  ├── useLocalStorage.ts                                                                                                                                
  ├── useDebounce.ts                                                                                                                                    
  └── useMediaQuery.ts                                                                                                                                  
                                                                                                                                                        
  6.3 重组组件结构                                                                                                                                      
  - 特性为基础的组织：                                                                                                                                  
  components/                                                                                                                                           
  ├── shared/               # 通用可复用组件                                                                                                            
  ├── agent/                # Agent 功能组件                                                                                                            
  ├── project/              # 项目特定组件                                                                                                              
  ├── tenant/               # 租户特定组件                                                                                                              
  └── layouts/              # 布局组件                                                                                                                  
                                                                                                                                                        
  ---                                                                                                                                                   
  第 7 阶段：错误处理与恢复 (第 7 周)                                                                                                                   
                                                                                                                                                        
  7.1 添加服务错误处理                                                                                                                                  
  - 统一的 ApiError 类                                                                                                                                  
  - 一致的错误处理                                                                                                                                      
                                                                                                                                                        
  7.2 添加重试逻辑                                                                                                                                      
  - 指数退避重试                                                                                                                                        
                                                                                                                                                        
  7.3 每个路由添加 React Error Boundary                                                                                                                 
                                                                                                                                                        
  ---                                                                                                                                                   
  第 8 阶段：可访问性改进 (第 8 周)                                                                                                                     
                                                                                                                                                        
  8.1 添加 ARIA 标签                                                                                                                                    
  - 图标按钮、表单输入、导航元素                                                                                                                        
                                                                                                                                                        
  8.2 实现焦点管理                                                                                                                                      
  - Modal focus trap                                                                                                                                    
                                                                                                                                                        
  8.3 键盘导航                                                                                                                                          
  - Dropdowns、Modals、Lists                                                                                                                            
                                                                                                                                                        
  ---                                                                                                                                                   
  第 9 阶段：测试增强 (第 9 周)                                                                                                                         
                                                                                                                                                        
  9.1 提高测试覆盖率 - 达到 80%+                                                                                                                        
                                                                                                                                                        
  9.2 添加 E2E 测试 - Playwright                                                                                                                        
                                                                                                                                                        
  ---                                                                                                                                                   
  第 10 阶段：文档与清理 (第 10 周)                                                                                                                     
                                                                                                                                                        
  10.1 移除 Console.log                                                                                                                                 
                                                                                                                                                        
  10.2 添加组件文档 - JSDoc 注释                                                                                                                        
                                                                                                                                                        
  10.3 更新导入路径 - 使用 barrel exports                                                                                                               
                                                                                                                                                        
  ---                                                                                                                                                   
  风险与缓解措施                                                                                                                                        
  ┌────────────────────────────┬────────────────────────────┐                                                                                           
  │            风险            │          缓解措施          │                                                                                           
  ├────────────────────────────┼────────────────────────────┤                                                                                           
  │ Store 拆分期间的破坏性更改 │ 增量迁移，保持导出兼容     │                                                                                           
  ├────────────────────────────┼────────────────────────────┤                                                                                           
  │ 过度优化导致的性能回退     │ 前后基准测试，衡量实际影响 │                                                                                           
  ├────────────────────────────┼────────────────────────────┤                                                                                           
  │ 重组后导入路径问题         │ 使用 IDE 重构工具          │                                                                                           
  ├────────────────────────────┼────────────────────────────┤                                                                                           
  │ 状态管理 bug               │ 全面的集成测试             │                                                                                           
  └────────────────────────────┴────────────────────────────┘                                                                                           
  ---                                                                                                                                                   
  时间估算                                                                                                                                              
  ┌─────────────┬──────┬────────┐                                                                                                                       
  │    阶段     │ 时长 │ 复杂度 │                                                                                                                       
  ├─────────────┼──────┼────────┤                                                                                                                       
  │ 1: 基础     │ 1 周 │ 低-中  │                                                                                                                       
  ├─────────────┼──────┼────────┤                                                                                                                       
  │ 2: 状态管理 │ 1 周 │ 高     │                                                                                                                       
  ├─────────────┼──────┼────────┤                                                                                                                       
  │ 3: 性能     │ 1 周 │ 中     │                                                                                                                       
  ├─────────────┼──────┼────────┤                                                                                                                       
  │ 4: API 服务 │ 1 周 │ 高     │                                                                                                                       
  ├─────────────┼──────┼────────┤                                                                                                                       
  │ 5: 类型安全 │ 1 周 │ 中     │                                                                                                                       
  ├─────────────┼──────┼────────┤                                                                                                                       
  │ 6: 组件     │ 1 周 │ 高     │                                                                                                                       
  ├─────────────┼──────┼────────┤                                                                                                                       
  │ 7: 错误处理 │ 1 周 │ 中     │                                                                                                                       
  ├─────────────┼──────┼────────┤                                                                                                                       
  │ 8: 可访问性 │ 1 周 │ 低     │                                                                                                                       
  ├─────────────┼──────┼────────┤                                                                                                                       
  │ 9: 测试     │ 1 周 │ 中     │                                                                                                                       
  ├─────────────┼──────┼────────┤                                                                                                                       
  │ 10: 清理    │ 1 周 │ 低     │                                                                                                                       
  └─────────────┴──────┴────────┘                                                                                                                       
  总计: 10 周                                                                     