# Plan Mode é›†æˆå’Œå¢å¼ºå®æ–½è®¡åˆ’

## 1. éœ€æ±‚é‡è¿°

Plan Mode æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆ (206 æµ‹è¯•é€šè¿‡)ï¼Œéœ€è¦è¿›è¡Œä»¥ä¸‹é›†æˆå’Œå¢å¼ºï¼š

1. **ReActAgent é›†æˆ** - åœ¨ç°æœ‰ ReAct æµç¨‹ä¸­æ·»åŠ  Plan Mode è§¦å‘é€»è¾‘
2. **å‰ç«¯ Store æ›´æ–°** - åœ¨ Zustand store ä¸­æ·»åŠ  Plan Mode çŠ¶æ€ç®¡ç†
3. **å¤æ‚æŸ¥è¯¢æ£€æµ‹** - å®ç°å¯å‘å¼ç®—æ³•è‡ªåŠ¨è§¦å‘ Plan Mode
4. **æ€§èƒ½ä¼˜åŒ–** - LLM å“åº”ç¼“å­˜ï¼Œå¹¶è¡Œæ‰§è¡Œä¼˜åŒ–
5. **ç”¨æˆ·äº¤äº’å¢å¼º** - è°ƒæ•´æ‰¹å‡†/æ‹’ç» UI äº¤äº’

## 2. æ¶æ„è®¾è®¡

### 2.1 æ–¹æ¡ˆé€‰æ‹©ï¼šæ··åˆæ£€æµ‹ç­–ç•¥

**é‡‡ç”¨æ–¹æ¡ˆ C**ï¼šæ··åˆæ–¹æ¡ˆç»“åˆå¯å‘å¼è§„åˆ™å’Œ LLM åˆ¤æ–­ï¼Œå¹³è¡¡æ€§èƒ½ã€æˆæœ¬å’Œå‡†ç¡®ç‡ã€‚

#### ä¸‰å±‚æ£€æµ‹ç­–ç•¥

```
ç¬¬ 1 å±‚ï¼šå¿«é€Ÿå¯å‘å¼è¿‡æ»¤
    â†“
æ˜æ˜¾ç®€å•æŸ¥è¯¢ (< 30 å­—ç¬¦) â†’ å¿«é€Ÿæ‹’ç»
    â†“
ç¬¬ 2 å±‚ï¼šå¯å‘å¼è¯„åˆ†
    â†“
æ˜æ˜¾å¤æ‚æŸ¥è¯¢ (è¯„åˆ† > 0.8) â†’ å¿«é€Ÿé€šè¿‡
æ˜æ˜¾ç®€å•æŸ¥è¯¢ (è¯„åˆ† < 0.2) â†’ å¿«é€Ÿæ‹’ç»
    â†“
ç¬¬ 3 å±‚ï¼šè¾¹ç•Œæƒ…å†µ â†’ LLM åˆ¤æ–­ + ç¼“å­˜
    â†“
è¿”å›ç»“æœ + ç¼“å­˜ä»¥ä¾›ä¸‹æ¬¡ä½¿ç”¨
```

#### æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | çº¯å¯å‘å¼ | çº¯ LLM | æ··åˆæ–¹æ¡ˆ |
|------|----------|--------|----------|
| å“åº”æ—¶é—´ | 1-5 ms | 200-500 ms | 5-50 ms (90%+ ç¼“å­˜å‘½ä¸­) |
| å‡†ç¡®ç‡ | 60-70% | 85-95% | 85-90% |
| æˆæœ¬/åƒæ¬¡ | $0 | $0.10-0.50 | $0.01-0.10 |
| å¤šè¯­è¨€ | âŒ å·® | âœ… å¥½ | âœ… å¥½ |

### 2.2 ç»„ä»¶é›†æˆå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          User Query                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ReActAgent.stream()                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              HybridPlanModeDetector.should_trigger()                â”‚   â”‚
â”‚  â”‚  1. Fast heuristic filter (length check)                           â”‚   â”‚
â”‚  â”‚  2. Heuristic scoring (keywords, structure)                        â”‚   â”‚
â”‚  â”‚  3. LLM classification (edge cases) + cache                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚                                     â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      â”‚  Plan Mode    â”‚                 â”‚   Regular ReAct     â”‚
â”‚                      â”‚  Path         â”‚                 â”‚   Execution Path    â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                              â”‚
â”‚                              â–¼
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              PlanModeOrchestrator.execute_plan()                     â”‚ â”‚
â”‚  â”‚  - PlanGenerator.generate_plan() (with cache)                       â”‚ â”‚
â”‚  â”‚  - PlanExecutor.execute_plan() (parallel optimization)              â”‚ â”‚
â”‚  â”‚  - PlanReflector.reflect() (with cache)                            â”‚ â”‚
â”‚  â”‚  - PlanAdjuster.apply_adjustments()                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                              â”‚
â”‚                              â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                  SSE Events (9 Plan Mode events)                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Frontend (AgentStore)                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           Plan Mode State Management                                 â”‚  â”‚
â”‚  â”‚  - executionPlan: ExecutionPlan | null                              â”‚  â”‚
â”‚  â”‚  - reflectionResult: ReflectionResult | null                          â”‚  â”‚
â”‚  â”‚  - Plan Mode SSE event handlers                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚                                     â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ExecutionPlanProgress          PlanModeViewer + AdjustmentApproval
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 æ•°æ®æµ

**æŸ¥è¯¢å¤„ç†æµç¨‹**:

```
User Query
    â†“
HybridPlanModeDetector.analyze(query)
    â”œâ”€ ç¬¬ 1 å±‚: å¿«é€Ÿè¿‡æ»¤ (len < 30) â†’ æ‹’ç»
    â”œâ”€ ç¬¬ 2 å±‚: å¯å‘å¼è¯„åˆ†
    â”‚   â”œâ”€ è¯„åˆ† > 0.8 â†’ æ¥å— (å¿«é€Ÿè·¯å¾„)
    â”‚   â”œâ”€ è¯„åˆ† < 0.2 â†’ æ‹’ç» (å¿«é€Ÿè·¯å¾„)
    â”‚   â””â”€ 0.2 â‰¤ è¯„åˆ† â‰¤ 0.8 â†’ è¿›å…¥ç¬¬ 3 å±‚
    â””â”€ ç¬¬ 3 å±‚: LLM åˆ¤æ–­ + ç¼“å­˜
        â”œâ”€ æ£€æŸ¥ç¼“å­˜
        â”œâ”€ ç¼“å­˜å‘½ä¸­ â†’ è¿”å›ç¼“å­˜ç»“æœ
        â””â”€ ç¼“å­˜æœªå‘½ä¸­ â†’ è°ƒç”¨ LLM â†’ ç¼“å­˜ç»“æœ
    â†“
PlanModeOrchestrator.execute_plan(plan)
    â”œâ”€ PlanGenerator (å¸¦ç¼“å­˜)
    â”œâ”€ PlanExecutor (å¹¶è¡Œä¼˜åŒ–)
    â”œâ”€ PlanReflector (å¸¦ç¼“å­˜)
    â””â”€ PlanAdjuster
    â†“
SSE Events â†’ Frontend Store â†’ UI Components
```

### 2.4 æ¥å£å®šä¹‰

**HybridPlanModeDetector**:

```python
class HybridPlanModeDetector:
    """
    æ··åˆæ£€æµ‹ç­–ç•¥ï¼šå¿«é€Ÿå¯å‘å¼ + LLM åˆ¤æ–­ + ç¼“å­˜
    """

    def __init__(
        self,
        llm_client: LLMClient,
        use_cache: bool = True,
        cache_ttl: int = 3600,
        heuristic_threshold_high: float = 0.8,
        heuristic_threshold_low: float = 0.2,
    )

    async def should_trigger_plan_mode(
        self,
        query: str,
        context: list[Dict] | None = None,
    ) -> tuple[bool, str, float]:
        """
        åˆ¤æ–­æ˜¯å¦åº”è¯¥è§¦å‘ Plan Mode

        Returns:
            (æ˜¯å¦è§¦å‘, æ£€æµ‹æ–¹æ³•, ç½®ä¿¡åº¦)
            æ£€æµ‹æ–¹æ³•: "heuristic_fast", "heuristic_slow", "llm_cache", "llm_live"
        """

    def get_complexity_score(self, query: str) -> float:
        """è·å–å¯å‘å¼å¤æ‚åº¦è¯„åˆ† (0.0 - 1.0)"""
```

**LLMClassifier**:

```python
class LLMClassifier:
    """
    ä½¿ç”¨ LLM åˆ¤æ–­æŸ¥è¯¢æ˜¯å¦éœ€è¦ Plan Mode
    """

    async def classify(
        self,
        query: str,
        context: list[Dict] | None = None,
    ) -> tuple[bool, float]:
        """
        ä½¿ç”¨ LLM åˆ†ç±»æŸ¥è¯¢

        Returns:
            (æ˜¯å¦è§¦å‘, ç½®ä¿¡åº¦ 0.0-1.0)
        """
```

**LLMResponseCache**:

```python
class LLMResponseCache:
    """
    LLM å“åº”ç¼“å­˜ (ç”¨äº Plan Generator å’Œ Reflector)
    """

    async def get(
        self,
        query: str,
        context: str | None = None,
        system_prompt: str | None = None,
    ) -> str | None

    async def set(
        self,
        query: str,
        response: str,
        context: str | None = None,
        system_prompt: str | None = None,
    ) -> None
```

## 3. å®æ–½é˜¶æ®µ

### Phase 1: æ··åˆæ£€æµ‹å™¨å®ç° (ä¼˜å…ˆçº§: ğŸ”´ HIGH)

**æ–‡ä»¶**:
- `src/infrastructure/agent/planning/hybrid_plan_mode_detector.py` - æ··åˆæ£€æµ‹å™¨
- `src/infrastructure/agent/planning/llm_classifier.py` - LLM åˆ†ç±»å™¨
- `src/infrastructure/agent/planning/llm_cache.py` - LLM å“åº”ç¼“å­˜
- `src/tests/unit/infrastructure/agent/planning/test_hybrid_plan_mode_detector.py`
- `src/tests/unit/infrastructure/agent/planning/test_llm_classifier.py`
- `src/tests/unit/infrastructure/agent/planning/test_llm_cache.py`

**ä»»åŠ¡**:
1. å®ç° FastHeuristicDetector (å¿«é€Ÿå¯å‘å¼)
2. å®ç° LLMClassifier (LLM åˆ†ç±»)
3. å®ç° LLMResponseCache (ç¼“å­˜)
4. å®ç° HybridPlanModeDetector (æ··åˆåè°ƒ)
5. ç¼–å†™å•å…ƒæµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹**:
- æ˜æ˜¾ç®€å•æŸ¥è¯¢ (len < 30) â†’ å¿«é€Ÿæ‹’ç»
- æ˜æ˜¾å¤æ‚æŸ¥è¯¢ (è¯„åˆ† > 0.8) â†’ å¿«é€Ÿé€šè¿‡
- è¾¹ç•Œæƒ…å†µ â†’ LLM åˆ¤æ–­
- ç¼“å­˜å‘½ä¸­/æœªå‘½ä¸­
- å¤šè¯­è¨€æŸ¥è¯¢ (ä¸­è‹±æ··åˆ)

### Phase 2: ReActAgent é›†æˆ (ä¼˜å…ˆçº§: ğŸ”´ HIGH)

**æ–‡ä»¶**:
- `src/infrastructure/agent/core/react_agent.py` - æ·»åŠ  Plan Mode åˆ†æ”¯
- `src/configuration/di_container.py` - æ³¨å†Œæ£€æµ‹å™¨
- `src/configuration/config.py` - æ·»åŠ é…ç½®é¡¹

**ä»»åŠ¡**:
1. åœ¨ ReActAgent.stream() ä¸­æ·»åŠ æ£€æµ‹é€»è¾‘
2. å®ç°è®¡åˆ’æ‰§è¡Œæµç¨‹
3. å¤„ç† Plan Mode äº‹ä»¶
4. æ·»åŠ é…ç½®é¡¹

**ä»£ç ç¤ºä¾‹**:

```python
# In ReActAgent.stream()
if self.plan_mode_detector:
    should_trigger, method, confidence = await self.plan_mode_detector.should_trigger_plan_mode(
        user_message, conversation_context
    )

    if should_trigger:
        yield {
            "type": "plan_mode_triggered",
            "data": {"method": method, "confidence": confidence},
        }

        async for event in self._execute_plan_mode(...):
            yield event

        return  # Plan Mode å®Œæˆï¼Œä¸è¿›å…¥ ReAct å¾ªç¯
```

### Phase 3: å‰ç«¯ Store æ›´æ–° (ä¼˜å…ˆçº§: ğŸ”´ HIGH)

**æ–‡ä»¶**:
- `web/src/stores/agent.ts` - æ·»åŠ  Plan Mode çŠ¶æ€
- `web/src/types/agent.ts` - éªŒè¯ç±»å‹å®Œæ•´æ€§

**ä»»åŠ¡**:
1. æ·»åŠ  Plan Mode çŠ¶æ€åˆ° AgentState
2. å®ç° Plan Mode äº‹ä»¶å¤„ç†å™¨
3. æ·»åŠ çŠ¶æ€æ›´æ–°æ–¹æ³•

**çŠ¶æ€å®šä¹‰**:

```typescript
interface PlanModeState {
  executionPlan: ExecutionPlan | null;
  reflectionResult: ReflectionResult | null;
  planModeEvents: PlanModeEvent[];
  planModeStatus: "idle" | "planning" | "executing" | "reflecting" | "adjusting" | "complete" | "failed";
}
```

### Phase 4: æ€§èƒ½ä¼˜åŒ– (ä¼˜å…ˆçº§: ğŸŸ¡ MEDIUM)

**ä»»åŠ¡**:
1. **LLM ç¼“å­˜ä¼˜åŒ–**:
   - ç¼“å­˜ Plan ç”Ÿæˆç»“æœ
   - ç¼“å­˜ Reflection ç»“æœ
   - æ™ºèƒ½ç¼“å­˜å¤±æ•ˆç­–ç•¥

2. **å¹¶è¡Œæ‰§è¡Œä¼˜åŒ–**:
   - è¯†åˆ«ç‹¬ç«‹æ­¥éª¤
   - å¹¶è¡Œæ‰§è¡Œç‹¬ç«‹æ­¥éª¤
   - ç»“æœåˆå¹¶

3. **çŠ¶æ€æ›´æ–°ä¼˜åŒ–**:
   - æ‰¹é‡æ›´æ–°å‰ç«¯çŠ¶æ€
   - å‡å°‘ä¸å¿…è¦çš„é‡æ¸²æŸ“

### Phase 5: ç”¨æˆ·äº¤äº’å¢å¼º (ä¼˜å…ˆçº§: ğŸŸ¢ LOW)

**æ–‡ä»¶**:
- `web/src/components/agent/AdjustmentApprovalModal.tsx` - è°ƒæ•´æ‰¹å‡†å¼¹çª—
- `web/src/components/agent/PlanModeControls.tsx` - Plan Mode æ§åˆ¶ç»„ä»¶
- `web/src/components/agent/ReflectionResultViewer.tsx` - åæ€ç»“æœå±•ç¤º

**ä»»åŠ¡**:
1. å®ç°è°ƒæ•´æ‰¹å‡†/æ‹’ç» UI
2. æ˜¾ç¤ºåæ€ç»“æœå’Œç½®ä¿¡åº¦
3. äº¤äº’å†å²è®°å½•
4. å•é¡¹/æ‰¹é‡æ“ä½œ

## 4. ä¾èµ–å…³ç³»

```
Phase 1 (æ··åˆæ£€æµ‹å™¨)
    â”œâ”€â”€ æ— ä¾èµ–
    â””â”€â”€ é˜»å¡: Phase 2

Phase 2 (ReActAgent é›†æˆ)
    â”œâ”€â”€ ä¾èµ–: Phase 1
    â””â”€â”€ é˜»å¡: Phase 3, Phase 4

Phase 3 (å‰ç«¯ Store)
    â”œâ”€â”€ ä¾èµ–: Phase 2 (SSE äº‹ä»¶)
    â””â”€â”€ é˜»å¡: Phase 5

Phase 4 (æ€§èƒ½ä¼˜åŒ–)
    â”œâ”€â”€ ä¾èµ–: Phase 1 (ç¼“å­˜)
    â””â”€â”€ é˜»å¡: æ— 

Phase 5 (ç”¨æˆ·äº¤äº’)
    â”œâ”€â”€ ä¾èµ–: Phase 2, Phase 3
    â””â”€â”€ é˜»å¡: æ— 
```

## 5. é£é™©è¯„ä¼°

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| ç ´åç°æœ‰ ReAct æµç¨‹ | ä¸­ | é«˜ | Feature flag + å›å½’æµ‹è¯• |
| LLM æˆæœ¬è¿‡é«˜ | ä½ | ä¸­ | ç¼“å­˜ + å¿«é€Ÿè·¯å¾„è¿‡æ»¤ |
| å‰ç«¯çŠ¶æ€ä¸åŒæ­¥ | ä½ | ä¸­ | ä¸å¯å˜æ¨¡å¼ + äº‹ä»¶å»é‡ |
| ç¼“å­˜æ±¡æŸ“ | ä½ | ä½ | TTL + å“ˆå¸Œæ ¡éªŒ |
| æ£€æµ‹è¯¯åˆ¤ | ä¸­ | ä½ | å¯é…ç½®é˜ˆå€¼ + æ‰‹åŠ¨è¦†ç›– |

## 6. é…ç½®é€‰é¡¹

### æ–°å¢ç¯å¢ƒå˜é‡

```bash
# Plan Mode å¼€å…³
PLAN_MODE_ENABLED=false

# æ£€æµ‹ç­–ç•¥
PLAN_MODE_DETECTION_STRATEGY="hybrid"  # "heuristic", "llm", "hybrid"

# å¯å‘å¼é˜ˆå€¼
PLAN_MODE_HEURISTIC_THRESHOLD_HIGH=0.8
PLAN_MODE_HEURISTIC_THRESHOLD_LOW=0.2
PLAN_MODE_MIN_LENGTH=30

# LLM åˆ†ç±»
PLAN_MODE_LLM_CONFIDENCE_THRESHOLD=0.7
PLAN_MODE_LLM_MODEL="gemini"

# ç¼“å­˜
PLAN_MODE_CACHE_ENABLED=true
PLAN_MODE_CACHE_TTL=3600
PLAN_MODE_CACHE_MAX_SIZE=5000

# æ‰§è¡Œ
PLAN_MODE_MAX_REFLECTION_CYCLES=3
PLAN_MODE_PARALLEL_EXECUTION_ENABLED=true
```

## 7. æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•

| ç»„ä»¶ | æµ‹è¯•æ•° | è¦†ç›–ç‡ |
|------|--------|--------|
| FastHeuristicDetector | 5-7 | 90%+ |
| LLMClassifier | 4-6 | 85%+ |
| LLMResponseCache | 5-8 | 95%+ |
| HybridPlanModeDetector | 8-12 | 90%+ |

### é›†æˆæµ‹è¯•

| åœºæ™¯ | æµ‹è¯•æ•° |
|------|--------|
| ç®€å•æŸ¥è¯¢ (æ—  Plan Mode) | 3-5 |
| å¤æ‚æŸ¥è¯¢ + Plan Mode | 5-8 |
| æ··åˆæ£€æµ‹è·¯å¾„ | 4-6 |
| ç¼“å­˜å‘½ä¸­/æœªå‘½ä¸­ | 3-4 |
| LLM å›é€€ | 2-3 |

### E2E æµ‹è¯•

| ç”¨æˆ·æ—…ç¨‹ | æµ‹è¯•æ•° |
|----------|--------|
| è‡ªåŠ¨è§¦å‘ Plan Mode | 2-3 |
| Plan æ‰§è¡Œæµç¨‹ | 3-5 |
| è°ƒæ•´æ‰¹å‡†æµç¨‹ | 2-3 |

## 8. å¤æ‚åº¦è¯„ä¼°

| Phase | å·¥ä½œé‡ | ä¼˜å…ˆçº§ |
|-------|--------|--------|
| Phase 1: æ··åˆæ£€æµ‹å™¨ | 3-4 å¤© | ğŸ”´ HIGH |
| Phase 2: ReActAgent é›†æˆ | 3-4 å¤© | ğŸ”´ HIGH |
| Phase 3: å‰ç«¯ Store | 2-3 å¤© | ğŸ”´ HIGH |
| Phase 4: æ€§èƒ½ä¼˜åŒ– | 2-3 å¤© | ğŸŸ¡ MEDIUM |
| Phase 5: ç”¨æˆ·äº¤äº’ | 3-4 å¤© | ğŸŸ¢ LOW |

**æ€»å·¥ä½œé‡**: 13-18 å¤©

## 9. å‘åå…¼å®¹æ€§

âœ… **å®Œå…¨å…¼å®¹**:
- Plan Mode é»˜è®¤ç¦ç”¨ (opt-in)
- ç°æœ‰ API æ— å˜åŒ–
- ç°æœ‰ UI ç»„ä»¶æ­£å¸¸å·¥ä½œ
- æ¸è¿›å¼éƒ¨ç½²

## 10. ç›‘æ§æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡

- **æ£€æµ‹å‡†ç¡®ç‡**: çœŸé˜³æ€§ç‡ / å‡é˜³æ€§ç‡
- **ç¼“å­˜å‘½ä¸­ç‡**: ç¼“å­˜å‘½ä¸­æ¯”ä¾‹ (ç›®æ ‡: >80%)
- **LLM è°ƒç”¨æ¬¡æ•°**: æ¯åƒæ¬¡æŸ¥è¯¢çš„ LLM è°ƒç”¨
- **å“åº”æ—¶é—´**: Plan Mode è§¦å‘å»¶è¿Ÿ (ç›®æ ‡: <50ms)
- **æˆæœ¬**: æ¯åƒæ¬¡æŸ¥è¯¢çš„ LLM æˆæœ¬ (ç›®æ ‡: <$0.10)

### Dashboard

å»ºè®®åœ¨ Grafana ä¸­åˆ›å»ºä»¥ä¸‹é¢æ¿:
- Plan Mode è§¦å‘ç‡
- æ£€æµ‹æ–¹æ³•åˆ†å¸ƒ (heuristic_fast vs llm_live)
- ç¼“å­˜å‘½ä¸­ç‡
- å¹³å‡å“åº”æ—¶é—´
- LLM æˆæœ¬è¶‹åŠ¿

## 11. å®æ–½è·¯çº¿å›¾

### Milestone 1: MVP (Week 1-2)
- âœ… Phase 1: æ··åˆæ£€æµ‹å™¨ (å¯å‘å¼éƒ¨åˆ†)
- âœ… Phase 2: ReActAgent åŸºç¡€é›†æˆ
- âœ… åŸºæœ¬æµ‹è¯•è¦†ç›–

### Milestone 2: LLM å¢å¼º (Week 3)
- âœ… Phase 1: LLM åˆ†ç±»å™¨
- âœ… Phase 1: LLM ç¼“å­˜
- âœ… å®Œæ•´æ··åˆæ£€æµ‹ç­–ç•¥

### Milestone 3: å‰ç«¯é›†æˆ (Week 4)
- âœ… Phase 3: Store æ›´æ–°
- âœ… Phase 4: æ€§èƒ½ä¼˜åŒ–
- âœ… é›†æˆæµ‹è¯•

### Milestone 4: ç”¨æˆ·ä½“éªŒ (Week 5)
- âœ… Phase 5: ç”¨æˆ·äº¤äº’
- âœ… E2E æµ‹è¯•
- âœ… æ–‡æ¡£å®Œå–„

## 12. æˆåŠŸæ ‡å‡†

- âœ… æ£€æµ‹å‡†ç¡®ç‡ > 85%
- âœ… ç¼“å­˜å‘½ä¸­ç‡ > 80%
- âœ… å¹³å‡å“åº”æ—¶é—´ < 50ms
- âœ… æµ‹è¯•è¦†ç›–ç‡ > 80%
- âœ… é›¶ç ´åæ€§å˜æ›´
- âœ… æ–‡æ¡£å®Œæ•´

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2026-01-29
**çŠ¶æ€**: âœ… å·²æ‰¹å‡†ï¼Œç­‰å¾…å®æ–½
