# ä¼ä¸šçº§ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ

> **æŠ€æœ¯é€‰å‹**: Temporal.io (çº¯ gRPC é€šä¿¡)  
> **ç›®æ ‡è§„æ¨¡**: 10000+ Workerï¼Œå®Œæ•´ DAG æ”¯æŒï¼Œç§Ÿæˆ·é˜Ÿåˆ—éš”ç¦»  
> **æ€§è´¨**: å…¨æ–°ç³»ç»Ÿè®¾è®¡  
> **å½“å‰çŠ¶æ€**: åŸºäºç°æœ‰ Redis é˜Ÿåˆ—ç³»ç»Ÿé‡æ„

---

## ä¸€ã€å½“å‰ç³»ç»Ÿåˆ†æ

### 1.1 ç°æœ‰æ¶æ„

MemStack å½“å‰ä½¿ç”¨**è‡ªç ”çš„ Redis é˜Ÿåˆ—ç³»ç»Ÿ**ï¼Œæ¶æ„æ¸…æ™°ä½†å­˜åœ¨æ‰©å±•é™åˆ¶ï¼š

```
src/
â”œâ”€â”€ infrastructure/adapters/secondary/queue/
â”‚   â””â”€â”€ redis_queue.py           # QueueService (36.4 KB, 867 è¡Œ)
â”œâ”€â”€ domain/tasks/base.py         # TaskHandler æŠ½è±¡åŸºç±»
â”œâ”€â”€ application/tasks/
â”‚   â”œâ”€â”€ registry.py              # TaskRegistry æ³¨å†Œè¡¨
â”‚   â”œâ”€â”€ episode.py               # EpisodeTaskHandler
â”‚   â”œâ”€â”€ community.py             # RebuildCommunityTaskHandler
â”‚   â”œâ”€â”€ incremental_refresh.py   # IncrementalRefreshTaskHandler
â”‚   â””â”€â”€ deduplicate_entities.py  # DeduplicateEntitiesTaskHandler
â”œâ”€â”€ domain/model/task/task_log.py # TaskLog åŸŸæ¨¡å‹
â””â”€â”€ worker.py                    # Worker å…¥å£ (259 è¡Œ)
```

### 1.2 å½“å‰æŠ€æœ¯æ ˆ
- **é˜Ÿåˆ—å­˜å‚¨**: Redis 7-alpine (docker-compose.yml å·²éƒ¨ç½²)
- **ä»»åŠ¡æ—¥å¿—**: PostgreSQL 16+ (task_logs è¡¨)
- **å¹¶å‘æ¨¡å‹**: asyncio.Task (å•è¿›ç¨‹ 20 åç¨‹)
- **åˆ†å¸ƒå¼é”**: Redis SET NX EX å‘½ä»¤
- **æ¢å¤æœºåˆ¶**: 60 ç§’è½®è¯¢æ¢å¤å¾ªç¯

### 1.3 ç°æœ‰åŠŸèƒ½
âœ… ä»»åŠ¡å…¥é˜Ÿ/å‡ºé˜Ÿ (4 ç§ä»»åŠ¡ç±»å‹)  
âœ… çŠ¶æ€è¿½è¸ª (PENDING â†’ PROCESSING â†’ COMPLETED/FAILED)  
âœ… è¿›åº¦ç™¾åˆ†æ¯”æ›´æ–° (0-100%)  
âœ… æ•…éšœæ¢å¤ (è¶…æ—¶ä»»åŠ¡è‡ªåŠ¨é‡å…¥é˜Ÿ)  
âœ… åŸºæœ¬é‡è¯•æœºåˆ¶  
âœ… åˆ†å¸ƒå¼é”é˜²æ­¢é‡å¤å¤„ç†  
âœ… TaskRegistry å¯æ‰©å±•æ¶æ„

### 1.4 å½“å‰é™åˆ¶

| åˆ†ç±» | é™åˆ¶ |
|------|------|
| **è°ƒåº¦èƒ½åŠ›** | æ— ä¼˜å…ˆçº§ã€æ— å®šæ—¶ä»»åŠ¡ã€æ—  DAG å·¥ä½œæµã€æ— å»¶è¿Ÿä»»åŠ¡ |
| **èµ„æºç®¡ç†** | æ— ç§Ÿæˆ·éš”ç¦»ã€æ— é¡¹ç›®é…é¢ã€æ— åŠ¨æ€èµ„æºåˆ†é… |
| **æ‰©å±•æ€§** | å•è¿›ç¨‹ 20 åç¨‹ã€æ— é›†ç¾¤ç®¡ç†ã€æ— åŠ¨æ€æ‰©ç¼©å®¹ |
| **å¯é æ€§** | ç®€å•é‡è¯•(æ— æŒ‡æ•°é€€é¿)ã€æ— æ­»ä¿¡é˜Ÿåˆ— |

---

## äºŒã€ç³»ç»Ÿéœ€æ±‚

| éœ€æ±‚ | è§„æ ¼ |
|------|------|
| **DAG å·¥ä½œæµ** | å®Œæ•´æ”¯æŒï¼ˆå¤æ‚å¤šåˆ†æ”¯ï¼Œå¯è§†åŒ–ç¼–æ’ï¼‰ |
| **å¹¶å‘è§„æ¨¡** | è¶…å¤§è§„æ¨¡ 10000+ Worker |
| **æ¶ˆæ¯é˜Ÿåˆ—** | ä¸éœ€è¦ï¼ˆTemporal åŸç”Ÿ gRPC é€šä¿¡ï¼‰ |
| **ç§Ÿæˆ·éš”ç¦»** | é€»è¾‘éš”ç¦»ï¼ˆTaskQueue è·¯ç”±ï¼‰ |
| **å…¼å®¹ç°æœ‰** | ä¿ç•™ 4 ä¸ªç°æœ‰ TaskHandlerï¼Œå¹³æ»‘è¿ç§» |

---

## ä¸‰ã€æŠ€æœ¯é€‰å‹: Temporal.io

### 3.1 é€‰å‹ç†ç”±

| ç»´åº¦ | Temporal.io ä¼˜åŠ¿ | ä¸ç°æœ‰ç³»ç»Ÿå¯¹æ¯” |
|------|-----------------|---------------|
| **DAG æ”¯æŒ** | åŸç”Ÿ Workflow + Activity | å½“å‰æ—  DAG èƒ½åŠ› |
| **è¶…å¤§è§„æ¨¡** | Uber/Netflix éªŒè¯ 10000+ Worker | å½“å‰å•è¿›ç¨‹ 20 åç¨‹ |
| **Python asyncio** | SDK åŸç”Ÿæ”¯æŒ | ä¸ç°æœ‰ async ä»£ç æ— ç¼é›†æˆ |
| **å¯é æ€§** | æŒä¹…åŒ–çŠ¶æ€ï¼Œæ•…éšœæ¢å¤ <1s | å½“å‰ 60s è½®è¯¢æ¢å¤ |
| **æ¶æ„å¥‘åˆ** | Activity = TaskHandler | å®Œç¾æ˜ å°„ç°æœ‰ 4 ä¸ª Handler |

### 3.2 ä¸å½“å‰æ¶æ„çš„æ˜ å°„å…³ç³»

```
ç°æœ‰ç»„ä»¶                  â†’  Temporal ç»„ä»¶
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TaskHandler               â†’  Activity
TaskRegistry              â†’  Worker æ³¨å†Œçš„ Activities
QueueService.add_episode  â†’  Client.start_workflow()
redis_queue._worker_loop  â†’  Worker.run()
Task.status (PENDING/...)  â†’  WorkflowExecution.status
Task.progress (0-100%)    â†’  Activity heartbeat
```

---

## å››ã€ç³»ç»Ÿæ¶æ„

### 4.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ API å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FastAPI Application                                        â”‚
â”‚  â”œâ”€â”€ WorkflowEnginePort (æ–°å¢ Interface)                   â”‚
â”‚  â””â”€â”€ TemporalWorkflowAdapter (Implementation)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ gRPC
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Temporal å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Temporal Cluster (3 Nodes HA)                             â”‚
â”‚  â”œâ”€â”€ Frontend Service (gRPC Gateway)                       â”‚
â”‚  â”œâ”€â”€ History Service (Workflow State)                      â”‚
â”‚  â”œâ”€â”€ Matching Service (Task Router + ä»»åŠ¡åˆ†å‘)             â”‚
â”‚  â””â”€â”€ PostgreSQL (Persistence)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ gRPC (é•¿è½®è¯¢)
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Worker å±‚ (åˆ†åŒº) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Worker Pool A (3000) â”‚ Pool B (3000) â”‚ Pool C (4000)      â”‚
â”‚  â”œâ”€â”€ TaskQueue: tenant-{id}-episode                        â”‚
â”‚  â”œâ”€â”€ TaskQueue: tenant-{id}-community                      â”‚
â”‚  â””â”€â”€ Activities: å¤ç”¨ç°æœ‰ 4 ä¸ª TaskHandler                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç›‘æ§å±‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Temporal UI â”‚ Prometheus (å·²æœ‰) â”‚ Grafana (å·²æœ‰)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ³¨: Temporal ä½¿ç”¨ gRPC ç›´æ¥ä¸ Worker é€šä¿¡ï¼Œæ— éœ€å¤–éƒ¨æ¶ˆæ¯é˜Ÿåˆ—
```

### 4.2 ç§Ÿæˆ·éš”ç¦» (TaskQueue è·¯ç”±)

```python
# TaskQueue å‘½åè§„åˆ™
TaskQueue: f"tenant-{tenant_id}-{task_type}"

# ç§Ÿæˆ·ç­‰çº§é…ç½®
Enterprise: ä¸“ç”¨ TaskQueue + ä¸“ç”¨ Worker Pool (5000)
VIP:        ä¸“ç”¨ TaskQueue + å…±äº« Pool (ä¼˜å…ˆçº§ +5)
Standard:   å…±äº« TaskQueue + å…±äº« Pool
```

### 4.3 DAG å·¥ä½œæµç¤ºä¾‹ (åŸºäºç°æœ‰ Episode å¤„ç†)

```
Episode Processing Workflow (å¯¹åº”ç°æœ‰ EpisodeTaskHandler)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¼€å§‹      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â–¼                 â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Extract    â”‚    â”‚ Extract    â”‚    â”‚ Validate   â”‚
â”‚ Entities   â”‚    â”‚ Relations  â”‚    â”‚ Embedding  â”‚
â”‚ (å¹¶è¡Œ)     â”‚    â”‚ (å¹¶è¡Œ)     â”‚    â”‚ Dimension  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
       â”‚                 â”‚                 â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Deduplicate â”‚
                  â”‚  Entities   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â–¼                       â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Community   â”‚ (æ¡ä»¶)   â”‚ Skip        â”‚
      â”‚ Update      â”‚         â”‚             â”‚
      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
             â”‚                       â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Sync Meta   â”‚
                  â”‚ & Complete  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”ã€æ ¸å¿ƒè®¾è®¡

### 5.1 ä¿ç•™ç°æœ‰ç»„ä»¶

**æ— éœ€ä¿®æ”¹çš„ç»„ä»¶** (å®Œå…¨ä¿ç•™):
- âœ… `src/domain/model/task/task_log.py` - åŸŸæ¨¡å‹
- âœ… `src/infrastructure/adapters/secondary/persistence/models.py` - TaskLog è¡¨
- âœ… `src/infrastructure/adapters/secondary/persistence/sql_task_repository.py` - ä»“å‚¨å®ç°
- âœ… `src/application/services/task_service.py` - ä»»åŠ¡æœåŠ¡
- âœ… `src/application/use_cases/task/*.py` - ä»»åŠ¡ç”¨ä¾‹

**å¾…é€‚é…çš„ç»„ä»¶**:
- ğŸ”„ `src/application/tasks/episode.py` â†’ Temporal Activity
- ğŸ”„ `src/application/tasks/community.py` â†’ Temporal Activity
- ğŸ”„ `src/application/tasks/incremental_refresh.py` â†’ Temporal Activity
- ğŸ”„ `src/application/tasks/deduplicate_entities.py` â†’ Temporal Activity

**å¾…æ›¿æ¢çš„ç»„ä»¶**:
- âŒ `src/infrastructure/adapters/secondary/queue/redis_queue.py` â†’ Temporal Client/Worker
- âŒ `src/worker.py` â†’ æ–°çš„ Temporal Worker å…¥å£

### 5.2 æ–°å¢ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ domain/
â”‚   â””â”€â”€ ports/
â”‚       â””â”€â”€ services/
â”‚           â””â”€â”€ workflow_engine_port.py    # æ–°å¢ï¼šå·¥ä½œæµå¼•æ“æŠ½è±¡æ¥å£
â”‚
â”œâ”€â”€ infrastructure/
â”‚   â”œâ”€â”€ temporal/                          # æ–°å¢ç›®å½•
â”‚   â”‚   â”œâ”€â”€ client.py                      # Temporal Client é…ç½®
â”‚   â”‚   â”œâ”€â”€ worker.py                      # Temporal Worker å…¥å£ (æ›¿æ¢ src/worker.py)
â”‚   â”‚   â”œâ”€â”€ workflows/                     # Workflow å®šä¹‰
â”‚   â”‚   â”‚   â”œâ”€â”€ episode_workflow.py        # Episode å¤„ç† Workflow
â”‚   â”‚   â”‚   â”œâ”€â”€ community_workflow.py      # ç¤¾åŒºé‡å»º Workflow
â”‚   â”‚   â”‚   â”œâ”€â”€ incremental_refresh_workflow.py
â”‚   â”‚   â”‚   â””â”€â”€ deduplicate_workflow.py
â”‚   â”‚   â””â”€â”€ activities/                    # Activity é€‚é…å±‚
â”‚   â”‚       â”œâ”€â”€ episode_activity.py        # åŒ…è£… EpisodeTaskHandler
â”‚   â”‚       â”œâ”€â”€ community_activity.py      # åŒ…è£… RebuildCommunityTaskHandler
â”‚   â”‚       â”œâ”€â”€ incremental_refresh_activity.py
â”‚   â”‚       â””â”€â”€ deduplicate_activity.py
â”‚   â”‚
â”‚   â””â”€â”€ adapters/
â”‚       â””â”€â”€ secondary/
â”‚           â””â”€â”€ workflow/
â”‚               â””â”€â”€ temporal_adapter.py    # æ–°å¢ï¼šTemporal é€‚é…å™¨
â”‚
â””â”€â”€ configuration/
    â”œâ”€â”€ temporal_config.py                 # æ–°å¢ï¼šTemporal é…ç½®
    â””â”€â”€ di_container.py                    # ä¿®æ”¹ï¼šæ³¨å…¥ Temporal ä¾èµ–
```

### 5.3 æ ¸å¿ƒæ¥å£å®šä¹‰

```python
# src/domain/ports/services/workflow_engine_port.py
from abc import ABC, abstractmethod
from typing import Any, Dict, Optional
from dataclasses import dataclass

@dataclass
class WorkflowExecution:
    workflow_id: str
    run_id: str
    status: str  # RUNNING, COMPLETED, FAILED, CANCELLED

class WorkflowEnginePort(ABC):
    """å·¥ä½œæµå¼•æ“æŠ½è±¡æ¥å£ (å…­è¾¹å½¢æ¶æ„çš„æ¬¡è¦ç«¯å£)"""
    
    @abstractmethod
    async def start_workflow(
        self,
        workflow_type: str,
        workflow_input: Dict[str, Any],
        task_queue: str,
        workflow_id: Optional[str] = None,
    ) -> WorkflowExecution:
        """å¯åŠ¨å·¥ä½œæµ (å¯¹åº”ç°æœ‰çš„ QueueService.add_episode)"""
        pass
    
    @abstractmethod
    async def get_workflow_status(self, workflow_id: str) -> WorkflowExecution:
        """æŸ¥è¯¢å·¥ä½œæµçŠ¶æ€ (å¯¹åº”ç°æœ‰çš„ TaskService.get_task_status)"""
        pass
    
    @abstractmethod
    async def get_workflow_result(self, workflow_id: str) -> Dict[str, Any]:
        """è·å–å·¥ä½œæµç»“æœ"""
        pass
    
    @abstractmethod
    async def cancel_workflow(self, workflow_id: str) -> bool:
        """å–æ¶ˆå·¥ä½œæµ (å¯¹åº”ç°æœ‰çš„ TaskService.stop_task)"""
        pass
    
    @abstractmethod
    async def signal_workflow(
        self, workflow_id: str, signal_name: str, payload: Dict[str, Any]
    ) -> bool:
        """å‘å·¥ä½œæµå‘é€ä¿¡å· (æ–°èƒ½åŠ›)"""
        pass
```

### 5.4 Activity é€‚é…ç¤ºä¾‹

```python
# src/infrastructure/temporal/activities/episode_activity.py
from temporalio import activity
from typing import Dict, Any
from src.application.tasks.episode import EpisodeTaskHandler

@activity.defn
async def episode_processing_activity(payload: Dict[str, Any]) -> Dict[str, Any]:
    """
    Episode å¤„ç† Activity
    
    é€‚é…ç°æœ‰çš„ EpisodeTaskHandler:
    - å¤ç”¨å®Œæ•´çš„ä¸šåŠ¡é€»è¾‘
    - æ·»åŠ  Temporal ç‰¹æœ‰çš„ heartbeat è¿›åº¦æŠ¥å‘Š
    - ä¿æŒåŸæœ‰çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
    """
    activity.logger.info(f"Processing episode: {payload.get('uuid')}")
    
    # 1. åˆ›å»ºç°æœ‰çš„ TaskHandler
    handler = EpisodeTaskHandler()
    
    # 2. åŒ…è£… context (ä» QueueService è½¬ä¸º Activity info)
    class ActivityContext:
        def __init__(self):
            self.activity_info = activity.info()
            self.workflow_id = activity.info().workflow_id
    
    context = ActivityContext()
    
    # 3. è°ƒç”¨ç°æœ‰çš„å¤„ç†é€»è¾‘ï¼ˆæ— éœ€ä¿®æ”¹ EpisodeTaskHandlerï¼‰
    try:
        await handler.process(payload, context)
        
        # 4. å‘é€ Temporal heartbeatï¼ˆå¯¹åº”åŸæœ‰çš„è¿›åº¦æ›´æ–°ï¼‰
        activity.heartbeat({"progress": 100, "status": "completed"})
        
        return {"status": "completed", "uuid": payload.get("uuid")}
    
    except Exception as e:
        activity.logger.error(f"Episode processing failed: {e}")
        raise  # Temporal è‡ªåŠ¨å¤„ç†é‡è¯•
```

### 5.5 Workflow å®šä¹‰ç¤ºä¾‹

```python
# src/infrastructure/temporal/workflows/episode_workflow.py
from temporalio import workflow
from temporalio.common import RetryPolicy
from datetime import timedelta
from dataclasses import dataclass

@dataclass
class EpisodeInput:
    """å¯¹åº”ç°æœ‰çš„ episode payload"""
    episode_id: str
    content: str
    tenant_id: str
    project_id: str
    rebuild_communities: bool = False

@dataclass
class EpisodeResult:
    episode_id: str
    entities_count: int
    relationships_count: int
    status: str

@workflow.defn
class EpisodeProcessingWorkflow:
    """
    Episode å¤„ç†å·¥ä½œæµ
    
    å¯¹åº”ç°æœ‰çš„ EpisodeTaskHandlerï¼Œä½†å¢åŠ  DAG ç¼–æ’èƒ½åŠ›
    """
    
    @workflow.run
    async def run(self, input: EpisodeInput) -> EpisodeResult:
        # é‡è¯•ç­–ç•¥ï¼ˆå¯¹åº”ç°æœ‰çš„ retry_countï¼‰
        retry_policy = RetryPolicy(
            initial_interval=timedelta(seconds=1),
            maximum_interval=timedelta(minutes=10),
            maximum_attempts=3,
            backoff_coefficient=2.0,
        )
        
        # Step 1: è°ƒç”¨ episode_processing_activityï¼ˆåŒ…è£…ç°æœ‰é€»è¾‘ï¼‰
        result = await workflow.execute_activity(
            "episode_processing_activity",
            input.__dict__,
            start_to_close_timeout=timedelta(minutes=10),
            retry_policy=retry_policy,
        )
        
        # Step 2: æ¡ä»¶åˆ†æ”¯ - ç¤¾åŒºæ›´æ–°ï¼ˆå¯¹åº”ç°æœ‰é€»è¾‘ï¼‰
        if input.rebuild_communities:
            await workflow.execute_activity(
                "rebuild_community_activity",
                {"project_id": input.project_id},
                start_to_close_timeout=timedelta(minutes=30),
                retry_policy=retry_policy,
            )
        
        return EpisodeResult(
            episode_id=input.episode_id,
            entities_count=result.get("entities_count", 0),
            relationships_count=result.get("relationships_count", 0),
            status="COMPLETED"
        )
```

### 5.6 Temporal Adapter å®ç°

```python
# src/infrastructure/adapters/secondary/workflow/temporal_adapter.py
from temporalio.client import Client
from src.domain.ports.services.workflow_engine_port import (
    WorkflowEnginePort, WorkflowExecution
)

class TemporalWorkflowAdapter(WorkflowEnginePort):
    """Temporal é€‚é…å™¨ï¼Œå®ç° WorkflowEnginePort æ¥å£"""
    
    def __init__(self, client: Client):
        self._client = client
    
    async def start_workflow(
        self,
        workflow_type: str,
        workflow_input: Dict[str, Any],
        task_queue: str,
        workflow_id: Optional[str] = None,
    ) -> WorkflowExecution:
        """
        å¯åŠ¨å·¥ä½œæµ
        
        å¯¹åº”ç°æœ‰çš„ QueueService.add_episode()
        """
        workflow_id = workflow_id or f"{workflow_type}-{uuid4()}"
        
        handle = await self._client.start_workflow(
            workflow_type,
            workflow_input,
            id=workflow_id,
            task_queue=task_queue,
        )
        
        return WorkflowExecution(
            workflow_id=handle.id,
            run_id=handle.result_run_id,
            status="RUNNING"
        )
    
    async def get_workflow_status(self, workflow_id: str) -> WorkflowExecution:
        """å¯¹åº”ç°æœ‰çš„ TaskService.get_task_status()"""
        handle = self._client.get_workflow_handle(workflow_id)
        desc = await handle.describe()
        return WorkflowExecution(
            workflow_id=workflow_id,
            run_id=desc.run_id,
            status=desc.status.name
        )
    
    # ... å…¶ä»–æ–¹æ³•å®ç°
```

---

## å…­ã€éƒ¨ç½²é…ç½®

### 6.1 Docker Compose (åŸºäºç°æœ‰ docker-compose.yml æ‰©å±•)

```yaml
# docker-compose.temporal.yml (æ–°å¢æ–‡ä»¶)
version: "3.8"

services:
  # ä¿ç•™ç°æœ‰ PostgreSQLã€Neo4jã€Redis é…ç½®
  
  # æ–°å¢ï¼šTemporal PostgreSQL (ç‹¬ç«‹äºä¸» DB)
  temporal-postgresql:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: temporal
      POSTGRES_USER: temporal
      POSTGRES_PASSWORD: temporal
    volumes:
      - temporal-pg-data:/var/lib/postgresql/data
    healthcheck:
      test: pg_isready -U temporal
      interval: 10s
      timeout: 5s
      retries: 5

  # æ–°å¢ï¼šTemporal Server
  temporal:
    image: temporalio/auto-setup:latest
    depends_on:
      temporal-postgresql:
        condition: service_healthy
    environment:
      - DB=postgresql12
      - DB_PORT=5432
      - POSTGRES_SEEDS=temporal-postgresql
      - POSTGRES_USER=temporal
      - POSTGRES_PWD=temporal
    ports:
      - "7233:7233"
    healthcheck:
      test: temporal workflow list --namespace default
      interval: 30s
      timeout: 10s
      retries: 5

  # æ–°å¢ï¼šTemporal UI
  temporal-ui:
    image: temporalio/ui:latest
    depends_on:
      - temporal
    ports:
      - "8080:8080"
    environment:
      TEMPORAL_ADDRESS: temporal:7233

  # æ–°å¢ï¼šTemporal Worker (æ›¿æ¢ç°æœ‰ worker æœåŠ¡)
  temporal-worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    depends_on:
      temporal:
        condition: service_healthy
      postgres:
        condition: service_healthy
      neo4j:
        condition: service_started
    environment:
      TEMPORAL_ADDRESS: temporal:7233
      MAX_CONCURRENT_ACTIVITIES: 100
      TASK_QUEUE: default
      # å¤ç”¨ç°æœ‰ç¯å¢ƒå˜é‡
      DATABASE_URL: ${DATABASE_URL}
      NEO4J_URI: ${NEO4J_URI}
      REDIS_URL: ${REDIS_URL}
    deploy:
      replicas: 10  # åˆå§‹ 10 ä¸ªï¼Œå¯æ‰©å±•è‡³ 10000+

volumes:
  temporal-pg-data:
```

### 6.2 Worker Dockerfile (åŸºäºç°æœ‰ Dockerfile)

```dockerfile
# Dockerfile.worker (æ–°å»º)
FROM python:3.11-slim

WORKDIR /app

# å¤ç”¨ç°æœ‰ä¾èµ–
COPY pyproject.toml uv.lock ./
RUN pip install uv && uv sync --frozen

# æ–°å¢ Temporal SDK
RUN uv add temporalio

COPY src/ ./src/

ENV PYTHONPATH=/app

# æ–°çš„ Worker å…¥å£
CMD ["python", "-m", "src.infrastructure.temporal.worker"]
```

### 6.3 Worker å…¥å£ (åŸºäºç°æœ‰ src/worker.py æ”¹é€ )

```python
# src/infrastructure/temporal/worker.py
import asyncio
from temporalio.client import Client
from temporalio.worker import Worker

# å¯¼å…¥ç°æœ‰ç»„ä»¶
from src.infrastructure.temporal.workflows.episode_workflow import EpisodeProcessingWorkflow
from src.infrastructure.temporal.activities import (
    episode_processing_activity,
    rebuild_community_activity,
    incremental_refresh_activity,
    deduplicate_entities_activity,
)
from src.configuration.temporal_config import settings

async def main():
    """
    Temporal Worker ä¸»å…¥å£
    
    å¯¹åº”ç°æœ‰çš„ src/worker.py::main()ï¼Œä¿ç•™å…³é”®åˆå§‹åŒ–é€»è¾‘ï¼š
    - æ•°æ®åº“è¿æ¥éªŒè¯
    - LLM æä¾›å•†åˆå§‹åŒ–
    - Graphiti å®¢æˆ·ç«¯åˆ›å»º
    """
    
    # 1. å¤ç”¨ç°æœ‰åˆå§‹åŒ–é€»è¾‘
    from src.worker import initialize_default_llm_providers, create_graphiti_client
    
    await initialize_default_llm_providers()
    graphiti_client = await create_graphiti_client()
    
    # 2. è¿æ¥ Temporal
    client = await Client.connect(settings.temporal_address)
    
    # 3. åˆ›å»º Worker
    worker = Worker(
        client,
        task_queue=settings.task_queue,
        workflows=[
            EpisodeProcessingWorkflow,
            # å…¶ä»– 3 ä¸ª Workflow
        ],
        activities=[
            episode_processing_activity,
            rebuild_community_activity,
            incremental_refresh_activity,
            deduplicate_entities_activity,
        ],
        max_concurrent_activities=settings.max_concurrent_activities,
    )
    
    print(f"Starting Temporal worker on task queue: {settings.task_queue}")
    await worker.run()

if __name__ == "__main__":
    asyncio.run(main())
```

---

## ä¸ƒã€å…³é”®å®ç°æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ | åŸºäºç°æœ‰ |
|----------|------|---------|
| `src/domain/ports/services/workflow_engine_port.py` | å·¥ä½œæµå¼•æ“æŠ½è±¡æ¥å£ | æ–°å»º |
| `src/infrastructure/adapters/secondary/workflow/temporal_adapter.py` | Temporal é€‚é…å™¨ | æ–°å»º |
| `src/infrastructure/temporal/client.py` | Temporal Client é…ç½® | æ–°å»º |
| `src/infrastructure/temporal/worker.py` | Temporal Worker å…¥å£ | åŸºäº src/worker.py æ”¹é€  |
| `src/infrastructure/temporal/workflows/*.py` | 4 ä¸ª Workflow å®šä¹‰ | æ–°å»º |
| `src/infrastructure/temporal/activities/*.py` | 4 ä¸ª Activity é€‚é… | åŒ…è£…ç°æœ‰ TaskHandler |
| `src/configuration/temporal_config.py` | Temporal é…ç½® | åŸºäº config.py æ‰©å±• |
| `src/configuration/di_container.py` | ä¾èµ–æ³¨å…¥æ›´æ–° | ä¿®æ”¹ |
| `docker-compose.temporal.yml` | éƒ¨ç½²é…ç½® | åŸºäºç°æœ‰ docker-compose.yml æ‰©å±• |
| `Dockerfile.worker` | Worker é•œåƒ | åŸºäºç°æœ‰ Dockerfile |

---

## å…«ã€æ€§èƒ½ç›®æ ‡

| æŒ‡æ ‡ | å½“å‰ (Redis é˜Ÿåˆ—) | ç›®æ ‡ (Temporal) | æå‡ |
|------|------------------|----------------|------|
| æœ€å¤§ Worker | 20 (å•è¿›ç¨‹åç¨‹) | 10000+ (åˆ†å¸ƒå¼) | **500x** |
| è°ƒåº¦å»¶è¿Ÿ P95 | ~500ms (è½®è¯¢) | ~50ms (gRPC) | **10x** |
| æ•…éšœæ¢å¤ | 60s (recovery_loop) | <1s (äº‹ä»¶é©±åŠ¨) | **60x** |
| DAG æ”¯æŒ | âŒ æ—  | âœ… åŸç”Ÿ Workflow | - |
| ç§Ÿæˆ·éš”ç¦» | âŒ æ—  | âœ… TaskQueue è·¯ç”± | - |

---

## ä¹ã€éªŒè¯è®¡åˆ’

### 9.1 åŠŸèƒ½éªŒè¯
```bash
# 1. å¯åŠ¨ Temporal é›†ç¾¤
docker-compose -f docker-compose.temporal.yml up -d

# 2. è¿è¡Œ Temporal Worker
python -m src.infrastructure.temporal.worker

# 3. è¿è¡Œç°æœ‰æµ‹è¯•ï¼ˆéªŒè¯å…¼å®¹æ€§ï¼‰
make test-integration

# 4. è¿è¡Œ Temporal ç‰¹å®šæµ‹è¯•
uv run pytest src/tests/integration/test_temporal_workflow.py -v
```

### 9.2 å‹åŠ›æµ‹è¯•
```bash
# 10000 å¹¶å‘ Workflow æµ‹è¯•
uv run pytest src/tests/performance/test_temporal_throughput.py -v
```

### 9.3 ç›‘æ§æŒ‡æ ‡
- Temporal UI: http://localhost:8080
- Prometheus (ç°æœ‰): http://localhost:9090
- Grafana (ç°æœ‰): http://localhost:3001

---

## åã€æ¶æ„ä¼˜åŠ¿

| æ–¹é¢ | ä¼˜åŠ¿ | ç›¸æ¯”å½“å‰ç³»ç»Ÿ |
|------|------|-------------|
| **ç®€åŒ–éƒ¨ç½²** | æ— éœ€å¤–éƒ¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒTemporal å†…ç½®è°ƒåº¦ | å‡å°‘ Redis é˜Ÿåˆ—å¤æ‚åº¦ |
| **åŸç”Ÿé€šä¿¡** | gRPC é•¿è½®è¯¢ï¼Œä½å»¶è¿Ÿä»»åŠ¡åˆ†å‘ | æ¯”è½®è¯¢å¿« 10x |
| **å¯æ‰©å±•æ€§** | Worker æ°´å¹³æ‰©å±•ï¼Œæ— ç“¶é¢ˆ | å•è¿›ç¨‹ â†’ åˆ†å¸ƒå¼ |
| **DAG ç¼–æ’** | åŸç”Ÿæ”¯æŒå¤æ‚å·¥ä½œæµ | å½“å‰æ— æ­¤èƒ½åŠ› |
| **çŠ¶æ€æŒä¹…åŒ–** | Workflow çŠ¶æ€è‡ªåŠ¨æŒä¹…åŒ– | å½“å‰ä»… TaskLog |
| **ä»£ç å¤ç”¨** | ç°æœ‰ TaskHandler æ— éœ€ä¿®æ”¹ | å¹³æ»‘è¿ç§» |

---

## åä¸€ã€è¿ç§»ç­–ç•¥

### 11.1 ä¿æŒå‘åå…¼å®¹

1. **ä¿ç•™æ‰€æœ‰ç°æœ‰ä»£ç **
   - TaskLog è¡¨ä¸å˜
   - TaskHandler é€»è¾‘ä¸å˜
   - API ç«¯ç‚¹ä¸å˜

2. **æ–°å¢ Temporal å±‚**
   - Activity åŒ…è£… TaskHandler
   - Workflow ç¼–æ’ Activity
   - Adapter å®ç°æ–°æ¥å£

3. **æ¸è¿›å¼åˆ‡æ¢**
   - é˜¶æ®µ 1: éƒ¨ç½² Temporalï¼Œä¿æŒ Redis é˜Ÿåˆ—è¿è¡Œ
   - é˜¶æ®µ 2: æ–°ä»»åŠ¡èµ° Temporalï¼Œæ—§ä»»åŠ¡èµ° Redis
   - é˜¶æ®µ 3: å®Œå…¨åˆ‡æ¢åˆ° Temporalï¼Œä¸‹çº¿ Redis é˜Ÿåˆ—

### 11.2 æµ‹è¯•è¦†ç›–

- âœ… å•å…ƒæµ‹è¯•ï¼šActivity é€‚é…å™¨
- âœ… é›†æˆæµ‹è¯•ï¼šWorkflow ç«¯åˆ°ç«¯
- âœ… æ€§èƒ½æµ‹è¯•ï¼š10000 å¹¶å‘å‹æµ‹
- âœ… å…¼å®¹æ€§æµ‹è¯•ï¼šç°æœ‰ API ä¸å˜

---

## åäºŒã€é£é™©è¯„ä¼°

| é£é™© | å¯èƒ½æ€§ | ç¼“è§£æªæ–½ |
|-----|-------|---------|
| Temporal å­¦ä¹ æ›²çº¿ | ä¸­ | 2 å‘¨ PoC éªŒè¯ + å›¢é˜ŸåŸ¹è®­ |
| ç°æœ‰ä»£ç å…¼å®¹æ€§ | ä½ | Activity åŒ…è£… TaskHandlerï¼Œé€»è¾‘ä¸å˜ |
| æ€§èƒ½å›å½’ | ä½ | å‹æµ‹éªŒè¯ï¼Œä¿æŒ Redis é˜Ÿåˆ—ä½œä¸º fallback |
| è¿ç»´å¤æ‚åº¦ | ä¸­ | Docker Compose ä¸€é”®éƒ¨ç½² |
