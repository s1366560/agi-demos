# MemStack AgentV3 从零构建 - 里程碑规划与工作量评估

## 项目概述

基于架构文档从零开始构建完整的 AgentV3 系统，包括：

- 四层能力递进模型（L1 Tool → L2 Skill → L3 SubAgent → L4 Agent）
- DDD + 六边形架构
- Temporal.io 企业级工作流
- Native Graph Adapter 知识图谱引擎
- WebSocket 实时通信
- 完整前端实现
- 80%+ 测试覆盖率

### 团队配置

- 2 名后端工程师
- 1 名前端工程师
- AI 辅助开发（效率提升 30-50%）

---

## 完整功能范围

### 后端模块

| 模块         | 描述                         | 复杂度 |
| ------------ | ---------------------------- | ------ |
| 基础架构     | DDD 分层、依赖注入、配置管理 | 中     |
| 认证授权     | 用户、租户、API Key、权限    | 中     |
| L1 工具层    | 20+ Agent 工具实现           | 高     |
| L2 技能层    | 技能定义、匹配、执行         | 高     |
| L3 子代理层  | 子代理路由、编排             | 高     |
| L4 核心层    | ReAct 引擎、上下文管理       | 高     |
| Temporal     | 工作流、活动、信号处理       | 高     |
| Native Graph | 实体抽取、混合搜索、社区检测 | 高     |
| WebSocket    | 双向通信、事件流             | 中     |
| 人机交互     | 澄清、决策、权限、死循环检测 | 中     |

### 前端模块

| 模块           | 描述                      | 复杂度 |
| -------------- | ------------------------- | ------ |
| 基础框架       | React + TypeScript + Vite | 低     |
| 状态管理       | Zustand stores            | 中     |
| Agent Chat     | 对话界面、SSE/WebSocket   | 高     |
| 技能管理       | 技能编辑器、列表          | 中     |
| 子代理管理     | 配置、监控界面            | 中     |
| 知识图谱可视化 | 实体、关系展示            | 中     |
| 任务监控       | Temporal 工作流状态       | 中     |

---

## 里程碑规划

### Phase 0: 基础架构 (2 周)

**目标**: 搭建 DDD + 六边形架构基础框架

| 任务             | 描述                            | 工作量 |
| ---------------- | ------------------------------- | ------ |
| 0.1 项目骨架     | 目录结构、配置管理、日志        | 2 人天 |
| 0.2 领域层基础   | 基础实体、值对象、领域事件      | 3 人天 |
| 0.3 应用层基础   | 用例基类、服务基类、DTO 模式    | 2 人天 |
| 0.4 基础设施层   | PostgreSQL、Redis、Neo4j 适配器 | 4 人天 |
| 0.5 依赖注入     | DI 容器、工厂模式               | 2 人天 |
| 0.6 API 框架     | FastAPI 路由、中间件、异常处理  | 2 人天 |
| 0.7 认证授权     | 用户、租户、API Key、RBAC       | 4 人天 |
| 0.8 基础测试框架 | pytest 配置、fixtures、CI       | 2 人天 |

**原始工作量**: 21 人天  
**AI 辅助后**: 13 人天  
**3 人周期**: 5 天 (1 周)

---

### Phase 1: L1 工具层 (2 周)

**目标**: 实现 20+ Agent 工具

| 任务         | 描述                                            | 工作量 |
| ------------ | ----------------------------------------------- | ------ |
| 1.1 工具基类 | AgentTool 抽象类、参数 Schema                   | 2 人天 |
| 1.2 记忆工具 | memory_search, memory_create, episode_retrieval | 4 人天 |
| 1.3 图谱工具 | entity_lookup, graph_query                      | 3 人天 |
| 1.4 网络工具 | web_search, web_scrape                          | 3 人天 |
| 1.5 交互工具 | clarification, decision                         | 3 人天 |
| 1.6 分析工具 | summary, code_executor                          | 3 人天 |
| 1.7 计划工具 | plan_enter, plan_exit, plan_update              | 2 人天 |
| 1.8 工具注册 | 工具发现、注册、权限检查                        | 2 人天 |
| 1.9 单元测试 | 工具层 80% 覆盖                                 | 4 人天 |

**原始工作量**: 26 人天  
**AI 辅助后**: 16 人天  
**3 人周期**: 6 天 (1.2 周)

---

### Phase 2: L4 ReAct 核心引擎 (3 周)

**目标**: 实现完整的 ReAct 推理循环

| 任务             | 描述                       | 工作量 |
| ---------------- | -------------------------- | ------ |
| 2.1 LLM 抽象层   | LiteLLM 集成、多提供商支持 | 4 人天 |
| 2.2 LLM 流式接口 | 流式响应、Token 计数       | 3 人天 |
| 2.3 ReAct 处理器 | 思考-行动-观察循环         | 6 人天 |
| 2.4 工具调用解析 | Function calling、参数映射 | 3 人天 |
| 2.5 上下文管理   | Token 预算、压缩策略       | 4 人天 |
| 2.6 权限管理     | Allow/Deny/Ask 三级控制    | 3 人天 |
| 2.7 死循环检测   | 重复调用检测、干预机制     | 2 人天 |
| 2.8 重试策略     | 指数退避、可重试异常       | 2 人天 |
| 2.9 成本追踪     | Token 计费、多模型支持     | 3 人天 |
| 2.10 事件系统    | SSE 事件定义、发送         | 3 人天 |
| 2.11 单元测试    | ReAct 核心 80% 覆盖        | 5 人天 |

**原始工作量**: 38 人天  
**AI 辅助后**: 24 人天  
**3 人周期**: 8 天 (1.6 周)

---

### Phase 3: L2 技能层 (2 周)

**目标**: 实现完整的技能系统

| 任务             | 描述                           | 工作量 |
| ---------------- | ------------------------------ | ------ |
| 3.1 技能领域模型 | Skill 实体、触发条件、工具序列 | 3 人天 |
| 3.2 技能匹配引擎 | 关键词/语义/混合匹配           | 4 人天 |
| 3.3 技能执行器   | 直接执行 vs 提示注入           | 4 人天 |
| 3.4 技能加载器   | 文件系统/数据库加载            | 2 人天 |
| 3.5 技能版本管理 | 版本控制、回滚                 | 3 人天 |
| 3.6 技能学习引擎 | 从成功执行中学习               | 4 人天 |
| 3.7 技能仓储     | 持久化、查询                   | 2 人天 |
| 3.8 单元测试     | 技能层 80% 覆盖                | 3 人天 |

**原始工作量**: 25 人天  
**AI 辅助后**: 16 人天  
**3 人周期**: 6 天 (1.2 周)

---

### Phase 4: L3 子代理层 (2 周)

**目标**: 实现子代理路由和编排

| 任务               | 描述                   | 工作量 |
| ------------------ | ---------------------- | ------ |
| 4.1 子代理领域模型 | SubAgent 实体、配置    | 2 人天 |
| 4.2 子代理路由器   | 关键词/描述匹配        | 3 人天 |
| 4.3 子代理执行器   | 隔离环境、配置覆盖     | 3 人天 |
| 4.4 链式编排       | A→B→C 串行调用         | 3 人天 |
| 4.5 并行编排       | 多子代理并行、结果合并 | 3 人天 |
| 4.6 故障转移       | 失败自动切换           | 2 人天 |
| 4.7 子代理仓储     | 持久化、管理 API       | 2 人天 |
| 4.8 单元测试       | 子代理层 80% 覆盖      | 3 人天 |

**原始工作量**: 21 人天  
**AI 辅助后**: 14 人天  
**3 人周期**: 5 天 (1 周)

---

### Phase 5: Native Graph Adapter (3 周)

**目标**: 实现完整的知识图谱引擎

| 任务                  | 描述                 | 工作量 |
| --------------------- | -------------------- | ------ |
| 5.1 Neo4j 客户端      | 驱动封装、连接池     | 3 人天 |
| 5.2 图模型定义        | 节点、关系、索引     | 2 人天 |
| 5.3 实体抽取器        | LLM 结构化输出       | 5 人天 |
| 5.4 关系抽取器        | LLM 关系发现         | 4 人天 |
| 5.5 Reflexion 迭代    | 完整性检查、补充抽取 | 3 人天 |
| 5.6 实体去重          | 向量相似度匹配       | 3 人天 |
| 5.7 向量搜索          | 向量索引、相似度查询 | 3 人天 |
| 5.8 关键词搜索        | 全文索引、BM25       | 2 人天 |
| 5.9 混合搜索          | RRF 融合排序         | 3 人天 |
| 5.10 Louvain 社区检测 | 社区划分算法         | 3 人天 |
| 5.11 社区摘要         | LLM 摘要生成         | 3 人天 |
| 5.12 嵌入服务         | 向量嵌入生成         | 2 人天 |
| 5.13 单元测试         | Graph 80% 覆盖       | 5 人天 |

**原始工作量**: 41 人天  
**AI 辅助后**: 26 人天  
**3 人周期**: 9 天 (1.8 周)

---

### Phase 6: Temporal.io 工作流 (2.5 周)

**目标**: 实现企业级工作流编排

| 任务                 | 描述                  | 工作量 |
| -------------------- | --------------------- | ------ |
| 6.1 Temporal 适配器  | 客户端、配置          | 2 人天 |
| 6.2 Worker 框架      | Worker 启动、生命周期 | 2 人天 |
| 6.3 Episode 工作流   | 处理管道、活动编排    | 4 人天 |
| 6.4 Entity 工作流    | 去重、合并工作流      | 3 人天 |
| 6.5 Community 工作流 | 社区检测、更新        | 3 人天 |
| 6.6 Agent 工作流     | ReAct 执行状态追踪    | 4 人天 |
| 6.7 信号处理         | 暂停/恢复/取消        | 3 人天 |
| 6.8 检查点保存       | 状态快照、恢复        | 4 人天 |
| 6.9 活动实现         | 各类活动函数          | 4 人天 |
| 6.10 Docker 配置     | Temporal 服务部署     | 1 人天 |
| 6.11 单元测试        | Temporal 80% 覆盖     | 4 人天 |

**原始工作量**: 34 人天  
**AI 辅助后**: 22 人天  
**3 人周期**: 8 天 (1.6 周)

---

### Phase 7: WebSocket 通信 (1.5 周)

**目标**: 实现双向实时通信

| 任务               | 描述                   | 工作量 |
| ------------------ | ---------------------- | ------ |
| 7.1 WebSocket 路由 | FastAPI WebSocket 端点 | 2 人天 |
| 7.2 连接管理器     | 连接池、会话管理       | 2 人天 |
| 7.3 事件协议       | 消息格式、事件类型     | 2 人天 |
| 7.4 心跳保活       | Ping/Pong、超时检测    | 1 人天 |
| 7.5 自动重连       | 客户端重连逻辑         | 2 人天 |
| 7.6 多会话订阅     | 多对话同时订阅         | 2 人天 |
| 7.7 SSE 兼容层     | 降级方案               | 2 人天 |
| 7.8 单元测试       | WebSocket 80% 覆盖     | 2 人天 |

**原始工作量**: 15 人天  
**AI 辅助后**: 10 人天  
**3 人周期**: 4 天 (0.8 周)

---

### Phase 8: 人机交互系统 (1.5 周)

**目标**: 实现完整的人机协作能力

| 任务             | 描述              | 工作量 |
| ---------------- | ----------------- | ------ |
| 8.1 澄清请求     | 规划阶段澄清问答  | 2 人天 |
| 8.2 决策请求     | 执行阶段决策点    | 2 人天 |
| 8.3 权限审批     | 工具执行权限控制  | 2 人天 |
| 8.4 死循环干预   | 检测和用户干预    | 2 人天 |
| 8.5 交互经验沉淀 | 记录、提取、复用  | 4 人天 |
| 8.6 单元测试     | 人机交互 80% 覆盖 | 2 人天 |

**原始工作量**: 14 人天  
**AI 辅助后**: 9 人天  
**3 人周期**: 3 天 (0.6 周)

---

### Phase 9: 前端实现 (4 周)

**目标**: 实现完整的 React 前端

| 任务                | 描述                      | 工作量 |
| ------------------- | ------------------------- | ------ |
| 9.1 项目骨架        | Vite + React + TypeScript | 2 人天 |
| 9.2 UI 组件库       | Ant Design 集成           | 1 人天 |
| 9.3 路由系统        | React Router 配置         | 1 人天 |
| 9.4 状态管理        | Zustand stores            | 3 人天 |
| 9.5 认证流程        | 登录、注册、API Key       | 3 人天 |
| 9.6 Agent Chat      | 对话界面、消息气泡        | 6 人天 |
| 9.7 WebSocket 服务  | 实时通信客户端            | 3 人天 |
| 9.8 工作计划可视化  | 计划卡片、步骤展示        | 3 人天 |
| 9.9 技能管理界面    | 技能列表、编辑器          | 4 人天 |
| 9.10 子代理管理     | 配置、监控界面            | 3 人天 |
| 9.11 知识图谱可视化 | 实体、关系图表            | 4 人天 |
| 9.12 任务监控       | Temporal 状态展示         | 3 人天 |
| 9.13 项目管理       | 项目 CRUD                 | 2 人天 |
| 9.14 用户设置       | 配置、偏好                | 2 人天 |
| 9.15 单元测试       | Vitest 前端测试           | 4 人天 |
| 9.16 E2E 测试       | Playwright 测试           | 4 人天 |

**原始工作量**: 48 人天  
**AI 辅助后**: 30 人天  
**3 人周期**: 10 天 (2 周)

---

### Phase 10: 集成测试与性能优化 (2 周)

**目标**: 完成集成测试和性能调优

| 任务                   | 描述               | 工作量 |
| ---------------------- | ------------------ | ------ |
| 10.1 Agent 集成测试    | 完整对话流程测试   | 4 人天 |
| 10.2 Temporal 集成测试 | 工作流端到端测试   | 3 人天 |
| 10.3 Graph 集成测试    | 图谱操作端到端测试 | 3 人天 |
| 10.4 API 契约测试      | OpenAPI 契约验证   | 2 人天 |
| 10.5 性能基准测试      | 关键路径性能基准   | 3 人天 |
| 10.6 故障恢复测试      | 各类故障场景测试   | 3 人天 |
| 10.7 负载测试          | 并发用户模拟       | 2 人天 |
| 10.8 性能优化          | 热点优化、缓存调优 | 4 人天 |

**原始工作量**: 24 人天  
**AI 辅助后**: 18 人天  
**3 人周期**: 6 天 (1.2 周)

---

### Phase 11: 可观测性与部署 (1.5 周)

**目标**: 生产级监控和部署能力

| 任务                | 描述                | 工作量 |
| ------------------- | ------------------- | ------ |
| 11.1 分布式追踪     | OpenTelemetry 集成  | 2 人天 |
| 11.2 监控指标       | Prometheus 指标收集 | 2 人天 |
| 11.3 Grafana 面板   | 监控仪表板          | 2 人天 |
| 11.4 告警规则       | 关键指标告警        | 1 人天 |
| 11.5 日志聚合       | 结构化日志、收集    | 2 人天 |
| 11.6 Docker Compose | 完整部署配置        | 2 人天 |
| 11.7 文档           | API 文档、运维手册  | 3 人天 |

**原始工作量**: 14 人天  
**AI 辅助后**: 9 人天  
**3 人周期**: 3 天 (0.6 周)

---

## 工作量汇总

| Phase    | 模块          | 原始工作量   | AI 辅助后    | 3 人周期  |
| -------- | ------------- | ------------ | ------------ | --------- |
| P0       | 基础架构      | 21 人天      | 13 人天      | 5 天      |
| P1       | L1 工具层     | 26 人天      | 16 人天      | 6 天      |
| P2       | L4 ReAct 核心 | 38 人天      | 24 人天      | 8 天      |
| P3       | L2 技能层     | 25 人天      | 16 人天      | 6 天      |
| P4       | L3 子代理层   | 21 人天      | 14 人天      | 5 天      |
| P5       | Native Graph  | 41 人天      | 26 人天      | 9 天      |
| P6       | Temporal      | 34 人天      | 22 人天      | 8 天      |
| P7       | WebSocket     | 15 人天      | 10 人天      | 4 天      |
| P8       | 人机交互      | 14 人天      | 9 人天       | 3 天      |
| P9       | 前端实现      | 48 人天      | 30 人天      | 10 天     |
| P10      | 集成测试      | 24 人天      | 18 人天      | 6 天      |
| P11      | 可观测性      | 14 人天      | 9 人天       | 3 天      |
| **总计** | -             | **321 人天** | **207 人天** | **73 天** |

---

## 时间线规划

### 推荐执行顺序（并行优化）

考虑依赖关系和团队并行能力，采用以下执行顺序：

```
第1-2周: 基础架构 (P0)
├── 后端1+2: 领域层、应用层、基础设施层、DI容器
└── 前端: 项目骨架、UI框架、路由

第3-4周: 工具层 + 核心引擎启动 (P1 + P2开始)
├── 后端1: L1 工具层实现
├── 后端2: LLM抽象层、流式接口
└── 前端: 状态管理、认证流程

第5-6周: ReAct 核心完成 (P2完成)
├── 后端1: ReAct处理器、工具调用解析
├── 后端2: 上下文管理、权限管理、事件系统
└── 前端: Agent Chat 界面

第7-8周: 技能层 + 子代理层 (P3 + P4)
├── 后端1: L2 技能层
├── 后端2: L3 子代理层
└── 前端: WebSocket服务、工作计划可视化

第9-11周: 知识图谱 (P5)
├── 后端1: 实体抽取、关系抽取、Reflexion
├── 后端2: 搜索引擎、社区检测
└── 前端: 技能管理界面、子代理管理

第12-13周: Temporal工作流 (P6)
├── 后端1: Episode/Entity工作流
├── 后端2: Agent工作流、信号处理
└── 前端: 知识图谱可视化

第14周: WebSocket + 人机交互 (P7 + P8)
├── 后端1: WebSocket通信
├── 后端2: 人机交互系统
└── 前端: 任务监控界面

第15-16周: 前端收尾 + 集成测试 (P9完成 + P10)
├── 后端1+2: 集成测试、性能优化
└── 前端: E2E测试、界面收尾

第17周: 可观测性与部署 (P11)
├── 后端1: 监控、告警
├── 后端2: 追踪、日志
└── 前端: 文档完善
```

### 总周期

**总计: 17 周 (约 4 个月)**

---

## 里程碑检查点

**项目启动日期: 2026-01-22 (周四)**  
**春节假期: 2026-02-14 ~ 2026-02-23 (10 天)**

| 里程碑              | 周次    | 交付日期      | 交付物           | 验收标准                       |
| ------------------- | ------- | ------------- | ---------------- | ------------------------------ |
| **M1: 基础架构**    | W1-W2   | 02-04 (周三)  | 可运行的骨架项目 | API 启动、数据库连接、认证可用 |
| 🧧 **春节假期**     | -       | 02-14 ~ 02-23 | -                | -                              |
| **M2: 工具层**      | W3-W4   | 03-02 (周一)  | 20+ 工具可用     | 所有工具单独测试通过           |
| **M3: ReAct 核心**  | W5-W6   | 03-16 (周一)  | 基础对话能力     | 简单问答 + 工具调用            |
| **M4: 技能+子代理** | W7-W8   | 03-30 (周一)  | 多层能力递进     | 技能匹配、子代理路由           |
| **M5: 知识图谱**    | W9-W11  | 04-20 (周一)  | 完整图谱能力     | 实体抽取、搜索、社区           |
| **M6: 工作流**      | W12-W13 | 05-04 (周一)  | 异步处理能力     | Episode 异步处理完整           |
| **M7: 通信+交互**   | W14     | 05-11 (周一)  | 实时交互能力     | WebSocket 双向通信             |
| **M8: 前端+测试**   | W15-W16 | 05-25 (周一)  | 完整系统可用     | 覆盖率 80%、E2E 通过           |
| **M9: 生产就绪**    | W17     | 06-01 (周一)  | 可部署版本       | 监控、告警、文档完整           |

### 甘特图视图

```
2026年
        1月           2月                    3月              4月              5月           6月
W1  W2  [春节假期]  W3  W4  W5  W6  W7  W8  W9  W10 W11 W12 W13 W14 W15 W16 W17
|---|---|==========|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
[P0 基础架构]
            🧧春节🧧
                    [P1 工具层  ]
                            [P2 ReAct核心   ]
                                    [P3+P4 技能/子代理]
                                            [P5 知识图谱           ]
                                                        [P6 Temporal    ]
                                                                [P7+P8]
                                                                    [P9 前端    ]
                                                                        [P10测试  ]
                                                                            [P11]
```

### 关键日期速查

| 日期                   | 事件                               |
| ---------------------- | ---------------------------------- |
| **2026-01-22**         | 项目启动                           |
| **2026-02-04**         | M1 基础架构交付                    |
| **2026-02-14 ~ 02-23** | 🧧 春节假期 (10 天)                |
| **2026-03-02**         | M2 工具层交付                      |
| **2026-03-16**         | M3 ReAct 核心交付 (首次可演示对话) |
| **2026-03-30**         | M4 技能+子代理交付                 |
| **2026-04-20**         | M5 知识图谱交付                    |
| **2026-05-04**         | M6 工作流交付                      |
| **2026-05-11**         | M7 通信+交互交付                   |
| **2026-05-25**         | M8 前端+测试交付 (内测版本)        |
| **2026-06-01**         | M9 生产就绪 (正式发布)             |

### 总周期

**有效工作周: 17 周**  
**春节假期: 10 天**  
**总日历周期: 约 19 周 (4.5 个月)**

---

## 风险评估

| 风险              | 概率 | 影响 | 缓解措施                |
| ----------------- | ---- | ---- | ----------------------- |
| LLM API 不稳定    | 中   | 高   | LiteLLM 多提供商切换    |
| Neo4j 性能瓶颈    | 低   | 中   | 索引优化、分页查询      |
| Temporal 学习曲线 | 中   | 中   | 参考文档、渐进式实现    |
| 前后端集成问题    | 中   | 中   | 早期联调、API 契约      |
| 测试覆盖率不足    | 中   | 高   | 每个 Phase 包含测试任务 |

---

## 资源需求

### 基础设施

| 服务            | 规格    | 用途         |
| --------------- | ------- | ------------ |
| PostgreSQL 16+  | 2 核 4G | 元数据存储   |
| Neo4j 5.26+     | 4 核 8G | 知识图谱     |
| Redis 7+        | 2 核 4G | 缓存、队列   |
| Temporal Server | 2 核 4G | 工作流引擎   |
| 应用服务器      | 4 核 8G | API + Worker |

### 外部服务

| 服务     | 用途               | 预算     |
| -------- | ------------------ | -------- |
| LLM API  | Gemini/Qwen/OpenAI | 根据用量 |
| 向量嵌入 | 文本向量化         | 根据用量 |

---

## 总结

| 指标             | 数值                                 |
| ---------------- | ------------------------------------ |
| **总工作量**     | 321 人天 (原始) / 207 人天 (AI 辅助) |
| **团队规模**     | 3 人 (2 后端 + 1 前端)               |
| **总周期**       | 17 周 (约 4 个月)                    |
| **测试覆盖目标** | 80%+                                 |
| **核心模块数**   | 12 个                                |

---

_文档版本: 2.0_  
_创建日期: 2026-01-21_  
_最后更新: 2026-01-21_
