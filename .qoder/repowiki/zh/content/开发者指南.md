# 开发者指南

<cite>
**本文档引用的文件**
- [README.md](file://README.md)
- [CLAUDE.md](file://CLAUDE.md)
- [Makefile](file://Makefile)
- [pyproject.toml](file://pyproject.toml)
- [.env.example](file://.env.example)
- [docker-compose.yml](file://docker-compose.yml)
- [sdk/python/pyproject.toml](file://sdk/python/pyproject.toml)
- [web/package.json](file://web/package.json)
- [web/vite.config.ts](file://web/vite.config.ts)
- [web/eslint.config.js](file://web/eslint.config.js)
- [web/tsconfig.json](file://web/tsconfig.json)
- [web/playwright.config.ts](file://web/playwright.config.ts)
- [pytest.ini](file://pytest.ini)
- [src/tests/conftest.py](file://src/tests/conftest.py)
- [examples/README.md](file://examples/README.md)
- [examples/basic_usage.py](file://examples/basic_usage.py)
- [examples/sdk_usage.py](file://examples/sdk_usage.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)
10. [附录](#附录)

## 简介
本指南面向希望参与 MemStack 项目的开发者，目标是帮助新贡献者快速上手本地开发与协作。内容涵盖：
- 开发环境搭建与 IDE 配置
- 代码规范（Python、TypeScript、文档）
- 贡献流程（提交规范、代码审查、版本发布）
- 开发工作流最佳实践（分支管理、冲突解决、测试要求）
- 开发命令与工具使用（格式化、lint、测试、数据库）
- 常见问题与调试技巧

## 项目结构
MemStack 采用前后端分离的双栈架构，后端基于 Python/FastAPI，前端基于 React/TypeScript，配合多数据库与 LLM 提供商集成。

```mermaid
graph TB
subgraph "后端"
A["src/<br/>Hexagonal 架构"]
B["配置与依赖注入<br/>configuration/"]
C["应用层用例与服务<br/>application/"]
D["领域模型与接口<br/>domain/"]
E["基础设施适配器<br/>infrastructure/"]
F["测试<br/>src/tests/"]
end
subgraph "前端"
G["web/src/<br/>React + TypeScript"]
H["构建与代理<br/>vite.config.ts"]
I["类型检查与 ESLint<br/>tsconfig.json + eslint.config.js"]
J["测试<br/>web/src/test/ + e2e/"]
end
subgraph "SDK"
K["sdk/python/<br/>Python SDK"]
end
subgraph "工具与运维"
L["Makefile<br/>开发命令"]
M["docker-compose.yml<br/>服务编排"]
N["pyproject.toml<br/>Python 依赖"]
O["web/package.json<br/>前端依赖"]
end
A --> B
A --> C
A --> D
A --> E
A --> F
G --> H
G --> I
G --> J
K --> N
L --> M
L --> N
L --> O
```

图表来源
- [Makefile](file://Makefile#L1-L498)
- [docker-compose.yml](file://docker-compose.yml#L1-L109)
- [pyproject.toml](file://pyproject.toml#L1-L131)
- [web/package.json](file://web/package.json#L1-L72)

章节来源
- [README.md](file://README.md#L487-L526)
- [Makefile](file://Makefile#L1-L498)

## 核心组件
- 后端（Python/FastAPI）：实现多层能力模型（工具→技能→子代理→代理），支持多 LLM 提供商、知识图谱与缓存。
- 前端（React/TypeScript）：基于 Ant Design 与 Zustand，提供代理聊天、知识图谱可视化、项目与租户管理等页面。
- SDK（Python）：提供同步与异步客户端，简化外部系统集成。
- 测试体系：后端 pytest、前端 Vitest/Playwright，覆盖单元、集成、性能与端到端测试。
- 开发工具链：Ruff（格式化/检查）、MyPy（类型检查）、Alembic（数据库迁移）。

章节来源
- [README.md](file://README.md#L91-L124)
- [CLAUDE.md](file://CLAUDE.md#L112-L182)
- [pyproject.toml](file://pyproject.toml#L10-L48)
- [web/package.json](file://web/package.json#L48-L70)

## 架构总览
MemStack 采用领域驱动设计（DDD）与六边形架构（端口与适配器），严格分层并依赖倒置，保证业务逻辑与框架/数据库解耦。

```mermaid
graph TB
subgraph "表现层"
FE["React 前端<br/>web/src/"]
end
subgraph "API 网关层"
API["FastAPI 路由与中间件<br/>infrastructure/adapters/primary/web/"]
end
subgraph "应用层"
UC["用例层<br/>application/use_cases/"]
SVC["应用服务<br/>application/services/"]
SCHEMA["DTO/Schema<br/>application/schemas/"]
end
subgraph "领域层"
ENT["实体与聚合<br/>domain/model/"]
PORTS["端口接口<br/>domain/ports/"]
LLM_IF["LLM 抽象<br/>domain/llm_providers/"]
end
subgraph "基础设施层"
PRI["主适配器<br/>infrastructure/adapters/primary/"]
SEC["次适配器<br/>infrastructure/adapters/secondary/"]
CFG["配置与 DI 容器<br/>configuration/"]
end
FE --> API
API --> UC
UC --> SVC
SVC --> ENT
ENT --> PORTS
PORTS --> PRI
PORTS --> SEC
PRI --> CFG
SEC --> CFG
```

图表来源
- [CLAUDE.md](file://CLAUDE.md#L112-L182)
- [README.md](file://README.md#L38-L80)

章节来源
- [CLAUDE.md](file://CLAUDE.md#L112-L182)

## 详细组件分析

### 后端开发环境与启动
- 依赖安装：推荐使用 uv，一键安装后端与前端依赖。
- 本地启动：通过 Makefile 提供统一入口，支持启动 API、Worker、前端与基础设施服务。
- Docker 编排：使用 docker-compose 启动 Neo4j、PostgreSQL、Redis、Prometheus、Grafana。

```mermaid
sequenceDiagram
participant Dev as "开发者"
participant MK as "Makefile"
participant DC as "Docker Compose"
participant API as "FastAPI 应用"
participant W as "Worker"
participant DB as "数据库/图库"
Dev->>MK : make dev
MK->>DC : 启动基础设施服务
MK->>API : uv run uvicorn 启动后端
MK->>W : python src/worker.py 启动队列处理
API->>DB : 初始化/迁移数据库
W->>DB : 消费队列任务
Dev-->>Dev : 访问 http : //localhost : 8000 与 http : //localhost : 3000
```

图表来源
- [Makefile](file://Makefile#L121-L172)
- [docker-compose.yml](file://docker-compose.yml#L1-L109)

章节来源
- [README.md](file://README.md#L125-L200)
- [Makefile](file://Makefile#L121-L172)
- [docker-compose.yml](file://docker-compose.yml#L1-L109)

### 前端开发环境与调试
- 开发服务器：Vite 提供热重载与代理，将 /api 请求转发至后端。
- 类型检查与 ESLint：TS 配置启用严格模式；ESLint 规则限制未使用变量等。
- E2E 测试：Playwright 配置自动启动前端并在失败时生成报告。

```mermaid
flowchart TD
Start(["启动前端开发"]) --> Install["安装依赖<br/>pnpm install"]
Install --> Dev["pnpm dev<br/>Vite 开发服务器"]
Dev --> Proxy["Vite 代理 /api -> http://localhost:8000"]
Dev --> TypeCheck["pnpm type-check<br/>TypeScript 类型检查"]
Dev --> Lint["pnpm lint<br/>ESLint 修复与检查"]
Dev --> Test["pnpm test<br/>Vitest 单元测试"]
Dev --> E2E["pnpm test:e2e<br/>Playwright 端到端测试"]
E2E --> Report["生成 HTML 报告"]
```

图表来源
- [web/package.json](file://web/package.json#L6-L16)
- [web/vite.config.ts](file://web/vite.config.ts#L16-L25)
- [web/eslint.config.js](file://web/eslint.config.js#L20-L35)
- [web/tsconfig.json](file://web/tsconfig.json#L20-L24)
- [web/playwright.config.ts](file://web/playwright.config.ts#L42-L48)

章节来源
- [web/package.json](file://web/package.json#L6-L16)
- [web/vite.config.ts](file://web/vite.config.ts#L16-L25)
- [web/eslint.config.js](file://web/eslint.config.js#L20-L35)
- [web/tsconfig.json](file://web/tsconfig.json#L20-L24)
- [web/playwright.config.ts](file://web/playwright.config.ts#L42-L48)

### 数据库与迁移
- 初始化：创建数据库、执行模式初始化、可选初始化默认数据。
- 迁移：使用 Alembic 自动生成与升级，遵循“从模型到迁移”的流程。
- 命令：提供 db-init、db-migrate、db-reset、db-shell 等常用命令。

```mermaid
flowchart TD
A["修改 SQLAlchemy 模型"] --> B["生成迁移<br/>alembic revision --autogenerate"]
B --> C["编辑迁移文件必要时"]
C --> D["升级到最新版本<br/>alembic upgrade head"]
D --> E["验证迁移结果"]
E --> F["回滚如需<br/>alembic downgrade -1"]
```

图表来源
- [CLAUDE.md](file://CLAUDE.md#L540-L595)
- [Makefile](file://Makefile#L271-L318)

章节来源
- [CLAUDE.md](file://CLAUDE.md#L540-L595)
- [Makefile](file://Makefile#L271-L318)

### 测试策略与覆盖率
- 后端：pytest 标记（unit/integration/performance/contract/security），默认排除 performance。
- 前端：Vitest 单测 + Playwright E2E，支持覆盖率。
- 覆盖率目标：整体 80%+。

```mermaid
graph LR
subgraph "后端测试"
U["单元测试<br/>pytest -m unit"]
I["集成测试<br/>pytest -m integration"]
P["性能测试<br/>pytest -m performance"]
C["契约/安全测试<br/>pytest -m contract/security"]
end
subgraph "前端测试"
V["Vitest 单元<br/>pnpm test"]
E["Playwright E2E<br/>pnpm test:e2e"]
end
subgraph "覆盖率"
COV["pytest --cov=src<br/>htmlcov/index.html"]
CE["前端覆盖率<br/>pnpm test:coverage"]
end
```

图表来源
- [pytest.ini](file://pytest.ini#L8-L21)
- [web/package.json](file://web/package.json#L12-L15)
- [Makefile](file://Makefile#L204-L207)

章节来源
- [pytest.ini](file://pytest.ini#L8-L21)
- [web/package.json](file://web/package.json#L12-L15)
- [Makefile](file://Makefile#L204-L207)

### SDK 使用示例
- Python SDK：提供同步与异步客户端，支持健康检查、创建 Episode、搜索记忆等。
- 示例脚本：examples/ 下包含基础用法与 SDK 使用示例。

章节来源
- [examples/README.md](file://examples/README.md#L1-L63)
- [examples/basic_usage.py](file://examples/basic_usage.py#L1-L107)
- [examples/sdk_usage.py](file://examples/sdk_usage.py#L1-L98)
- [sdk/python/pyproject.toml](file://sdk/python/pyproject.toml#L22-L25)

## 依赖关系分析
- Python 依赖：后端核心库、数据库 ORM、LLM 客户端、监控与队列等。
- 前端依赖：React 生态、Ant Design、Zustand、图表与国际化等。
- 开发工具：Ruff、MyPy、Alembic、Vite、ESLint、Playwright 等。

```mermaid
graph TB
PY["后端依赖<br/>pyproject.toml"] --> FA["FastAPI"]
PY --> SQ["SQLAlchemy"]
PY --> LC["LangChain"]
PY --> LL["LiteLLM"]
PY --> RE["Redis"]
PY --> NG["Neo4j/Graphiti"]
WEBPKG["前端依赖<br/>web/package.json"] --> RA["React/Ant Design"]
WEBPKG --> ZS["Zustand"]
WEBPKG --> VT["Vitest/Playwright"]
MK["开发命令<br/>Makefile"] --> PY
MK --> WEBPKG
```

图表来源
- [pyproject.toml](file://pyproject.toml#L10-L48)
- [web/package.json](file://web/package.json#L48-L70)
- [Makefile](file://Makefile#L101-L115)

章节来源
- [pyproject.toml](file://pyproject.toml#L10-L48)
- [web/package.json](file://web/package.json#L48-L70)
- [Makefile](file://Makefile#L101-L115)

## 性能考虑
- 并发与连接池：PostgreSQL 连接池参数（大小、溢出、回收）与 Redis 内存策略。
- LLM 缓存与超时：可配置 LLM 缓存 TTL 与请求超时。
- 图查询优化：Neo4j 堆与页缓存配置，Graphiti 并发限制。
- 监控与可观测性：Prometheus/Grafana、OpenTelemetry。

章节来源
- [.env.example](file://.env.example#L39-L43)
- [.env.example](file://.env.example#L128-L132)
- [.env.example](file://.env.example#L122-L126)
- [.env.example](file://.env.example#L133-L141)

## 故障排除指南
- 服务启动失败
  - 检查 Docker 服务是否正常，端口占用情况。
  - 查看日志：make dev-logs 或 docker-compose logs -f。
- 数据库迁移异常
  - 确认 Alembic 版本表存在；必要时手动 stamp 或删除重建。
  - 使用测试数据库验证迁移升级/降级。
- 前端代理无效
  - 确认 Vite 代理配置与环境变量 VITE_API_URL。
  - 清理 node_modules 缓存后重新安装依赖。
- 测试失败
  - 后端：使用 pytest -v --tb=short 定位；关注标记选择与忽略项。
  - 前端：Playwright 超时可适当增大 actionTimeout；CI 环境禁用并行。

章节来源
- [Makefile](file://Makefile#L149-L151)
- [CLAUDE.md](file://CLAUDE.md#L735-L756)
- [web/vite.config.ts](file://web/vite.config.ts#L19-L24)
- [pytest.ini](file://pytest.ini#L15-L21)
- [web/playwright.config.ts](file://web/playwright.config.ts#L12-L28)

## 结论
本指南提供了 MemStack 从环境搭建到日常开发、测试与运维的完整路径。建议新贡献者先完成环境准备与基础命令熟悉，再逐步深入架构与核心模块，最后结合测试与工具链形成稳定的工作流。

## 附录

### 开发环境搭建步骤
- 克隆仓库并安装依赖
  - 后端：uv sync --extra dev --extra neo4j --extra evaluation
  - 前端：cd web && pnpm install
- 配置环境变量：cp .env.example .env，并按需填写数据库、Redis、LLM 提供商密钥。
- 启动基础设施与服务：make dev-infra 与 make dev。
- 访问 API 文档与前端界面：http://localhost:8000/docs 与 http://localhost:3000。

章节来源
- [README.md](file://README.md#L135-L200)
- [.env.example](file://.env.example#L1-L158)
- [Makefile](file://Makefile#L165-L172)

### 代码规范与质量工具
- Python
  - 格式化：ruff --fix + ruff format
  - 检查：ruff check + mypy（忽略缺失导入）
  - 依赖：pyproject.toml 中 black、ruff、mypy 配置
- TypeScript
  - 格式化/检查：pnpm lint（含 --fix）
  - 类型检查：pnpm type-check
  - 依赖：web/package.json 中 ESLint、TS 配置
- 文档与示例
  - examples/ 提供 API 与 SDK 使用示例，便于快速验证。

章节来源
- [pyproject.toml](file://pyproject.toml#L82-L106)
- [web/package.json](file://web/package.json#L21-L47)
- [web/eslint.config.js](file://web/eslint.config.js#L20-L35)
- [web/tsconfig.json](file://web/tsconfig.json#L20-L24)
- [examples/README.md](file://examples/README.md#L1-L63)

### 贡献流程与最佳实践
- 分支管理
  - 建议基于 main 新建特性分支，命名如 feature/amazing-feature。
  - 提交前执行 make check（格式化 + lint + 测试）。
- 代码审查
  - 保持小步提交，清晰的提交信息与变更说明。
  - 关注测试覆盖率与性能标记测试。
- 版本发布
  - 变更记录与版本号更新遵循项目约定（如 CLAUDE.md 中的 OpenSpec 工作流）。

章节来源
- [README.md](file://README.md#L528-L547)
- [CLAUDE.md](file://CLAUDE.md#L757-L768)

### 开发命令速查
- 安装与更新：make install / make update
- 启动服务：make dev / make dev-backend / make dev-web / make dev-worker / make dev-infra
- 测试：make test / make test-unit / make test-integration / make test-coverage / make test-e2e
- 代码质量：make format / make lint / make type-check
- 数据库：make db-init / make db-migrate / make db-reset / make db-shell
- Docker：make docker-up / make docker-down / make docker-logs
- SDK：make sdk-install / make sdk-test / make sdk-build

章节来源
- [README.md](file://README.md#L318-L358)
- [Makefile](file://Makefile#L20-L91)