#!/bin/bash
# TigerVNC session startup script for XFCE 4.20 on Ubuntu 25.04
# This script is executed when a VNC session is started
# IMPORTANT: This script MUST keep running or the VNC session will terminate

# Detect running user and set paths dynamically
_UID=$(id -u)
_HOME=$(eval echo "~$(whoami)")
export HOME="${HOME:-$_HOME}"

# Get the VNC display number
DISPLAY=${DISPLAY:-:99}
export DISPLAY

# Set up XDG directories based on actual running user
export XDG_RUNTIME_DIR=${XDG_RUNTIME_DIR:-/run/user/$_UID}
export XDG_DATA_HOME="${HOME}/.local/share"
export XDG_CONFIG_HOME="${HOME}/.config"
export XDG_CACHE_HOME="${HOME}/.cache"
export XDG_STATE_HOME="${HOME}/.local/state"

# Create required directories
mkdir -p "$XDG_RUNTIME_DIR" 2>/dev/null
chmod 700 "$XDG_RUNTIME_DIR" 2>/dev/null || true
mkdir -p "$XDG_CONFIG_HOME/xfce4/xfconf/xfce-perchannel-xml"
mkdir -p "$XDG_CONFIG_HOME/xfce4/panel"
mkdir -p "$XDG_DATA_HOME"
mkdir -p "$XDG_CACHE_HOME"
mkdir -p /tmp/.ICE-unix
chmod 1777 /tmp/.ICE-unix 2>/dev/null || true

# Copy default XFCE configs on first run
if [ -d /etc/xdg/xfce4/xfconf/xfce-perchannel-xml ]; then
    for f in /etc/xdg/xfce4/xfconf/xfce-perchannel-xml/*.xml; do
        [ -f "$f" ] || continue
        cfgname="$(basename "$f")"
        [ -f "$XDG_CONFIG_HOME/xfce4/xfconf/xfce-perchannel-xml/$cfgname" ] || \
            cp "$f" "$XDG_CONFIG_HOME/xfce4/xfconf/xfce-perchannel-xml/" 2>/dev/null || true
    done
fi

[ -f "$XDG_CONFIG_HOME/xfce4/panel/whiskermenu-1.rc" ] || {
    mkdir -p "$XDG_CONFIG_HOME/xfce4/panel"
    cp /etc/xdg/xfce4/panel/whiskermenu-1.rc \
       "$XDG_CONFIG_HOME/xfce4/panel/" 2>/dev/null || true
}

# Unset session management variables for VNC
unset SESSION_MANAGER
unset DBUS_SESSION_BUS_ADDRESS
export DESKTOP_SESSION=xfce

# Start D-Bus session bus
mkdir -p "$XDG_RUNTIME_DIR"
if [ -S "$XDG_RUNTIME_DIR/bus" ]; then
    export DBUS_SESSION_BUS_ADDRESS="unix:path=$XDG_RUNTIME_DIR/bus"
else
    dbus-daemon --session --address="unix:path=$XDG_RUNTIME_DIR/bus" --nofork --syslog &
    sleep 1
    export DBUS_SESSION_BUS_ADDRESS="unix:path=$XDG_RUNTIME_DIR/bus"
fi

# Start XFCE configuration daemon
XFCONFD=$(find /usr/lib -name "xfconfd" -type f 2>/dev/null | head -1)
if [ -n "$XFCONFD" ] && [ -x "$XFCONFD" ]; then
    "$XFCONFD" --replace &
    sleep 1
fi

# Start XFCE 4.20 components for VNC session
[ -x /usr/bin/xfwm4 ] && /usr/bin/xfwm4 --display="$DISPLAY" &
sleep 0.5
[ -x /usr/bin/xfdesktop ] && /usr/bin/xfdesktop --display="$DISPLAY" &
sleep 0.5
[ -x /usr/bin/xfce4-panel ] && /usr/bin/xfce4-panel --display="$DISPLAY" &
sleep 0.5
[ -x /usr/bin/xfsettingsd ] && /usr/bin/xfsettingsd --display="$DISPLAY" &

# Keep script running to prevent VNC session from terminating
exec sleep infinity
