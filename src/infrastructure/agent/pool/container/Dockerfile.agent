# Agent Pool Worker Container Image
# This Dockerfile creates an isolated Agent worker for HOT tier deployment.
#
# Features:
# - Minimal Python 3.12 slim base
# - gRPC server for cross-container communication
# - Health check endpoint
# - Resource limits support
#
# Build:
#   docker build -f src/infrastructure/agent/pool/container/Dockerfile.agent -t memstack-agent-worker:latest .
#
# Run:
#   docker run -d --name agent-hot-1 \
#     -e AGENT_INSTANCE_ID=tenant:project:chat \
#     -e GRPC_PORT=50051 \
#     -p 50051:50051 \
#     memstack-agent-worker:latest

FROM python:3.12-slim AS base

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    g++ \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# ---------------------------------------------------------------------------
# Builder stage - install dependencies
# ---------------------------------------------------------------------------
FROM base AS builder

# Copy requirements first for caching
COPY pyproject.toml ./
COPY uv.lock ./

# Install uv and dependencies
RUN pip install uv && \
    uv pip install --system --no-cache -e . && \
    uv pip install --system --no-cache grpcio grpcio-tools

# ---------------------------------------------------------------------------
# Production stage
# ---------------------------------------------------------------------------
FROM base AS production

# Copy installed packages from builder
COPY --from=builder /usr/local/lib/python3.12/site-packages /usr/local/lib/python3.12/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

# Copy application code
COPY src/ /app/src/
COPY alembic/ /app/alembic/
COPY alembic.ini /app/

# Create non-root user
RUN groupadd -r agent && useradd -r -g agent agent \
    && chown -R agent:agent /app

USER agent

# Environment variables with defaults
ENV AGENT_INSTANCE_ID="" \
    AGENT_TENANT_ID="" \
    AGENT_PROJECT_ID="" \
    AGENT_MODE="chat" \
    GRPC_PORT=50051 \
    HEALTH_PORT=8080 \
    LOG_LEVEL=INFO \
    MAX_CONCURRENT_REQUESTS=50 \
    MEMORY_LIMIT_MB=2048 \
    IDLE_TIMEOUT_SECONDS=3600

# Expose ports
EXPOSE 50051 8080

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:${HEALTH_PORT}/health || exit 1

# Run the agent worker server
CMD ["python", "-m", "src.infrastructure.agent.pool.container.server"]
