# Docker Compose configuration for Agent Worker
# This file provides a dedicated container for the Agent Temporal Worker
# which can be deployed and scaled independently from the main worker.
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.agent-worker.yml up -d
#   docker compose -f docker-compose.yml -f docker-compose.agent-worker.yml down

services:
  # Agent Temporal Worker
  # Dedicated worker for Agent execution workflows
  agent-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: memstack-agent-worker
    command: uv run python src/agent_worker.py
    environment:
      # Temporal Settings
      - TEMPORAL_HOST=temporal:7233
      - TEMPORAL_NAMESPACE=default
      - AGENT_TEMPORAL_TASK_QUEUE=memstack-agent-tasks
      - AGENT_WORKER_CONCURRENCY=50
      - AGENT_PROVIDER_REFRESH_INTERVAL=60

      # Database Settings
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=your_password_here
      - DATABASE_URL=postgresql://postgres:your_password_here@postgres:5432/memstack
      - REDIS_URL=redis://redis:6379

      # LLM Provider Settings
      - LLM_PROVIDER=zai
      # - GEMINI_API_KEY=your_gemini_api_key_here
      # - DASHSCOPE_API_KEY=your_dashscope_api_key_here
      # - OPENAI_API_KEY=your_openai_api_key_here
      # - DEEPSEEK_API_KEY=your_deepseek_api_key_here
      - ZAI_API_KEY=your_zai_api_key_here

      # Logging
      - LOG_LEVEL=INFO
      - LOG_FORMAT=json
    depends_on:
      temporal:
        condition: service_healthy
      postgres:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      replicas: 1  # Increase for horizontal scaling
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
